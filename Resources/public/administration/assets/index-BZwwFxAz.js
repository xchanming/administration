const __vite__fileDeps=["assets/index-EE5C5myP.js","assets/index-DIyc9cj-.css","assets/index-BSJufXXe.js","assets/index-BpwMOWUh.css","assets/index-CxNycaw6.js","assets/index-ErEaXUTe.css","assets/index-DkUM8la7.js","assets/index-FpmpYvyZ.css","assets/index-DwtKetZz.js","assets/index-DPV1OC5B.css","assets/index-CzJt6ttk.js","assets/index-BlXfLLYZ.css","assets/index-CRzmX8ms.js","assets/index-DgnpdefV.css","assets/index-Cqzp6bZy.js","assets/index-C5z3ZrS5.css","assets/index-DVdwwX1W.js","assets/index-COpJlDvN.css","assets/index-al3ke0eK.js","assets/index-C_t65iXz.css","assets/index-7cR44Hkd.js","assets/main.vite-GBE0T_D3.js","assets/administration-BlrHhDOI.js","assets/administration-DZ0QGn6e.css","assets/channel-DxwX5hMG.js","assets/main-qZSDg39z.css","assets/index-BM140ZHA.css","assets/index-mB7ugQ3y.js","assets/index-CsQ8QWCJ.css","assets/index-D7lDgReY.js","assets/index-BVROjhAi.css","assets/index-H4mdGx5l.js","assets/index-CBvNXABW.css","assets/index-CFnB0Yay.js","assets/string.utils-Bdo6o_1y.js","assets/camelCase-C_yyocYD.js","assets/index-BShCuoPS.css","assets/index-DQPntCQA.js","assets/index-CoTc2DNb.css","assets/index-BNIItRmO.js","assets/_baseIteratee-vB4JeBI0.js","assets/_baseUniq-B2mRmqmX.js","assets/index-DQeE_2Fx.css","assets/index-DIHWuKhG.js","assets/index-Bbccf3rT.css","assets/index-CvbUrITH.js","assets/index-CpFd1jhz.css","assets/index-fpAkLmxb.js","assets/index-DXhakuGw.css","assets/index-BtgOO4Iq.js","assets/index-BZYxVpI4.css"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{_ as s}from"./administration-BlrHhDOI.js";import{A as g}from"./api.service-BUA61cyq.js";import"./channel-DxwX5hMG.js";class _ extends g{constructor(t,e,r="import-export"){super(t,e,r),this.onProgressStartedListener=[],this.name="importExportService",this.httpClient=t}async export(t,e,r){const i=new Date;i.setDate(i.getDate()+30);const n=await this.httpClient.post("/_action/import-export/prepare",{profileId:t,config:r,expireDate:i.toDateString()},{headers:this.getBasicHeaders()});return this.trackProgress(n,e)}async getDownloadUrl(t){const e=await this.httpClient.post(`/_action/import-export/file/prepare-download/${t}`,{},{headers:this.getBasicHeaders()});return`${Cicada.Context.api.apiPath||""}/_action/${this.getApiBasePath()}/file/download?fileId=${t}&accessToken=${e.data.accessToken}`}async getTemplateFileDownloadUrl(t){const e=await this.httpClient.post(`/_action/import-export/prepare-template-file-download?profileId=${t}`,{},{headers:this.getBasicHeaders()});return`${Cicada.Context.api.apiPath||""}/_action/${this.getApiBasePath()}/file/download?fileId=${e.data.fileId}&accessToken=${e.data.accessToken}`}getMappingFromTemplate(t,e,r=";",i='"'){const n=new FormData;return n.append("file",t),n.append("sourceEntity",e),n.append("delimiter",r),n.append("enclosure",i),this.httpClient.post("/_action/import-export/mapping-from-template",n,{headers:this.getBasicHeaders()}).then(a=>a.data?Promise.resolve(a.data):Promise.reject(new Error("Empty response data")))}async import(t,e,r,i={},n=!1){const a=new Date;a.setDate(a.getDate()+30);const o=new FormData;e&&o.append("file",e),o.append("profileId",t),o.append("expireDate",a.toDateString()),n&&o.append("dryRun","true"),Object.entries(i).forEach(([d,c])=>{o.append(`config[${d}]`,JSON.stringify(c))});const p=await this.httpClient.post("/_action/import-export/prepare",o,{headers:this.getBasicHeaders()});return this.trackProgress(p,r)}async trackProgress(t,e){return await this.httpClient.post("/_action/import-export/process",{logId:t.data.log.id},{headers:this.getBasicHeaders()}),e.call(this,t.data.log),this.onProgressStartedListener.forEach(r=>{r.call(this)}),t}addOnProgressStartedListener(t){this.onProgressStartedListener.push(t)}cancel(t){return this.httpClient.post(`/_action/${this.getApiBasePath()}/cancel`,{logId:t},{headers:this.getBasicHeaders()}).then(g.handleResponse.bind(this))}}class u{constructor(t){this.EntityDefinition=t}validate(t,e,r=[],i=!1){const n=this.convertMappingKeys(e),a=this.convertMappingKeys(r),o=this.EntityDefinition.getRequiredFields(t);let p=[];if(Object.keys(o).forEach(d=>{d==="translations"||d==="price"||a.length>0&&!a.some(l=>d===l)||n.includes(d)||p.push(d)}),i){const c=this.EntityDefinition.get(t).getPrimaryKeyFields();p=p.filter(l=>c[l]!==void 0)}return{missingRequiredFields:p}}convertMappingKeys(t){const e=t.map(r=>r.key);return e.forEach(r=>{const i=r.split(".");i.includes("translations")&&e.push(i.slice(2).join(""));const n=r.split(".id");n.length===2&&i.length===2&&e.push(`${n[0]}Id`)}),e}getSystemRequiredFields(t,e=1){const r=this.EntityDefinition.get(t);return this._getSystemRequiredFieldsForEntityCreation(r,e)}_getSystemRequiredFieldsForEntityCreation(t,e=1,r="",i={}){let n={};return e<=0||i[t.getEntity()]!==void 0||r.endsWith("translations.DEFAULT.language.")||(i[t.getEntity()]=t.getEntity(),t.forEachField((a,o,p)=>{n={...n,...this._handleField(a,o,p,e,r,i)}})),n}_handleField(t,e,r,i,n,a){let o={};if(t.type==="association"&&t.relation==="many_to_one"&&t.localField&&r[t.localField].flags.required===!0)return o={...o,...this._handleAssociation(t,e,r,i,n,a)},o;if(t.flags.required!==!0||e==="createdAt"||e.toLowerCase().includes("versionid")||t.flags.translatable===!0||t.type==="uuid"&&e!=="id")return o;if(e==="translations"&&t.type==="association"&&t.flags.required===!0)return o={...o,...this._getSystemRequiredFieldsForEntityCreation(this.EntityDefinition.get(t.entity),i,`${n}${e}.DEFAULT.`,a)},o;if(e==="price"&&t.type==="json_object")return o={...o,...this._addPriceFields(n,e)},o;const p=`${n}${e}`;return o[p]=p,o}_handleAssociation(t,e,r,i,n,a){const o={},p=`${n}${e}.`;if(a[t.entity]===void 0&&!p.endsWith("translations.DEFAULT.language.")){const c=`${p}${t.referenceField}`;o[c]=c}const d=this._getSystemRequiredFieldsForEntityCreation(this.EntityDefinition.get(t.entity),i-1,p,a);return{...o,...d}}_addPriceFields(t,e){const r={},i=`${t}${e}.DEFAULT.net`;r[i]=i;const n=`${t}${e}.DEFAULT.gross`;return r[n]=n,r}}class h{constructor(t){this.EntityDefinition=t}getEntity(t,e){const r=e.split("."),i=[];let n=this.EntityDefinition.get(t),a=!1,o=null,p=n.entity;return r.forEach(d=>{const c=n.properties[d];if(!c||d==="translations")return;if(c.flags.runtime===!0){n={entity:null};return}const l=c.entity;a=this.EntityDefinition.has(l),a&&(n=this.EntityDefinition.get(l),i.push(d),o=c.relation,p=d)}),{entity:n.entity,path:i.join("."),relation:o,name:p}}getSelected(t,e){const r=this.EntityDefinition.get(t),i=Object.keys(r.getPrimaryKeyFields())[0];if(!Array.isArray(e))return i;const n=this.getUpdateByMappingByEntity(t,e);return n?n.mappedKey:i}updateMapping(t,e,r){if(!e){this.removeUpdateByMappingByEntity(r,t.updateBy);return}if(!Array.isArray(t.updateBy)){t.updateBy=[{entityName:r,mappedKey:e}];return}const i=this.getUpdateByMappingByEntity(r,t.updateBy);if(!i){t.updateBy.push({entityName:r,mappedKey:e});return}i.mappedKey=e}getUpdateByMappingByEntity(t,e){const r=e.filter(i=>i.entityName===t);return r.length?r[0]:null}removeUpdateByMappingByEntity(t,e){if(!Array.isArray(e))return;const r=this.getUpdateByMappingByEntity(t,e);if(!r)return;const i=e.indexOf(r);i>-1&&e.splice(i,1)}removeUnusedMappings(t){if(!t||!Array.isArray(t.updateBy))return;if(!Array.isArray(t.mapping)||!t.mapping.length){t.updateBy=[];return}const e={};t.mapping.forEach(i=>{const{entity:n,path:a,relation:o}=this.getEntity(t.sourceEntity,i.key);if(o==="many_to_many"){e[n]=!0;return}e.hasOwnProperty(n)||(e[n]=[]);const p=a!==""?i.key.replace(new RegExp(`^(${a}.)`),""):i.key;e[n].push(p)}),t.updateBy.filter(i=>!e.hasOwnProperty(i.entityName)||Array.isArray(e[i.entityName])&&!e[i.entityName].includes(i.mappedKey)).forEach(i=>{this.removeUpdateByMappingByEntity(i.entityName,t.updateBy)})}}Cicada.Service("privileges").addPrivilegeMappingEntry({category:"additional_permissions",parent:null,key:"system",roles:{import_export:{privileges:["import_export_log:read","import_export_file:read","import_export_file:create","user:read","import_export_profile:read","import_export_profile:create","import_export_profile:delete","currency:read"],dependencies:[]}}});Cicada.Service().register("importExport",()=>new _(Cicada.Application.getContainer("init").httpClient,Cicada.Service("loginService")));Cicada.Service().register("importExportProfileMapping",()=>new u(Cicada.EntityDefinition));Cicada.Service().register("importExportUpdateByMapping",()=>new h(Cicada.EntityDefinition));Cicada.Component.register("sw-import-export",()=>s(()=>import("./index-EE5C5myP.js"),__vite__mapDeps([0,1])));Cicada.Component.register("sw-import-export-exporter",()=>s(()=>import("./index-BSJufXXe.js"),__vite__mapDeps([2,3])));Cicada.Component.register("sw-import-export-importer",()=>s(()=>import("./index-CxNycaw6.js"),__vite__mapDeps([4,5])));Cicada.Component.register("sw-import-export-activity",()=>s(()=>import("./index-DkUM8la7.js"),__vite__mapDeps([6,7])));Cicada.Component.register("sw-import-export-activity-log-info-modal",()=>s(()=>import("./index-DwtKetZz.js"),__vite__mapDeps([8,9])));Cicada.Component.register("sw-import-export-activity-result-modal",()=>s(()=>import("./index-CzJt6ttk.js"),__vite__mapDeps([10,11])));Cicada.Component.register("sw-import-export-edit-profile-modal",()=>s(()=>import("./index-CRzmX8ms.js"),__vite__mapDeps([12,13])));Cicada.Component.register("sw-import-export-edit-profile-modal-mapping",()=>s(()=>import("./index-Cqzp6bZy.js"),__vite__mapDeps([14,15])));Cicada.Component.register("sw-import-export-edit-profile-modal-identifiers",()=>s(()=>import("./index-DVdwwX1W.js"),__vite__mapDeps([16,17])));Cicada.Component.register("sw-import-export-entity-path-select",()=>s(()=>import("./index-al3ke0eK.js"),__vite__mapDeps([18,19])));Cicada.Component.register("sw-import-export-edit-profile-field-indicators",()=>s(()=>import("./index-7cR44Hkd.js"),__vite__mapDeps([20,21,22,23,24,25,26])));Cicada.Component.register("sw-import-export-edit-profile-import-settings",()=>s(()=>import("./index-mB7ugQ3y.js"),__vite__mapDeps([27,28])));Cicada.Component.register("sw-import-export-edit-profile-general",()=>s(()=>import("./index-D7lDgReY.js"),__vite__mapDeps([29,21,22,23,24,25,30])));Cicada.Component.register("sw-import-export-new-profile-wizard",()=>s(()=>import("./index-H4mdGx5l.js"),__vite__mapDeps([31,32])));Cicada.Component.register("sw-import-export-new-profile-wizard-general-page",()=>s(()=>import("./index-CFnB0Yay.js"),__vite__mapDeps([33,34,35,24,22,23,36])));Cicada.Component.register("sw-import-export-new-profile-wizard-csv-page",()=>s(()=>import("./index-DQPntCQA.js"),__vite__mapDeps([37,38])));Cicada.Component.register("sw-import-export-new-profile-wizard-mapping-page",()=>s(()=>import("./index-BNIItRmO.js"),__vite__mapDeps([39,24,22,23,40,41,42])));Cicada.Component.register("sw-import-export-view-import",()=>s(()=>import("./index-DIHWuKhG.js"),__vite__mapDeps([43,44])));Cicada.Component.register("sw-import-export-view-export",()=>s(()=>import("./index-CvbUrITH.js"),__vite__mapDeps([45,46])));Cicada.Component.register("sw-import-export-view-profiles",()=>s(()=>import("./index-fpAkLmxb.js"),__vite__mapDeps([47,48])));Cicada.Component.register("sw-import-export-progress",()=>s(()=>import("./index-BtgOO4Iq.js"),__vite__mapDeps([49,50])));Cicada.Module.register("sw-import-export",{type:"core",name:"ImportExport",title:"sw-import-export.general.mainMenuItemGeneral",description:"sw-import-export.general.descriptionTextModule",version:"1.0.0",targetVersion:"1.0.0",color:"#9AA8B5",icon:"regular-cog",entity:"import_export_profile",routePrefixPath:"sw/import-export",routes:{index:{component:"sw-import-export",path:"index",meta:{parentPath:"sw.settings.index",privilege:"system.import_export"},redirect:{name:"sw.import.export.index.import"},children:{import:{component:"sw-import-export-view-import",path:"import",meta:{parentPath:"sw.settings.index",privilege:"system.import_export"}},export:{component:"sw-import-export-view-export",path:"export",meta:{parentPath:"sw.settings.index",privilege:"system.import_export"}},profiles:{component:"sw-import-export-view-profiles",path:"profiles",meta:{parentPath:"sw.settings.index",privilege:"system.import_export"}}}}},settingsItem:{group:"shop",to:"sw.import.export.index",icon:"regular-database",privilege:"system.import_export"}});
//# sourceMappingURL=index-BZwwFxAz.js.map
