import{DocumentEvents as u}from"./document.api.service-DdEvgX5v.js";import{s as _}from"./main-DGszniXu.js";import"./api.service-DUFBkRAb.js";import"./channel-Cvr-E4M4.js";import"./administration-CcAM5iN0.js";const w=`{% block sw_order_document_card %} <sw-card v-show="!isDataLoading" position-identifier="sw-order-document-card" :title="$tc('sw-order.documentCard.cardTitle')" :class="documentCardStyles" :is-loading="isDataLoading" class="sw-order-detail-base__document-grid" > <template #grid> {% block sw_order_document_card_header %} <sw-card-section divider="bottom" :secondary="showCardFilter" slim > {% block sw_order_document_card_header_filter %} <sw-card-filter v-if="showCardFilter" :placeholder="$tc('sw-order.documentCard.searchBarPlaceholder')" @sw-card-filter-term-change="onSearchTermChange" > <template #filter> {% block sw_order_document_card_header_create_document_context_button %} <sw-button v-if="!attachView" v-tooltip="{ message: tooltipCreateDocumentButton, disabled: acl.can('document.viewer') && !isEditing, showOnDisabledElements: true }" size="small" variant="ghost" :disabled="!acl.can('document.viewer') || isEditing" class="sw-order-document-grid-button" @click="onShowSelectDocumentTypeModal" > {% block sw_order_document_card_header_create_document_button_label %} {{ $tc('sw-order.documentCard.labelCreateNew') }} {% endblock %} </sw-button> {% endblock %} </template> </sw-card-filter> {% endblock %} </sw-card-section> {% endblock %} {% block sw_order_document_card_grid %} <sw-data-grid v-if="!documentsEmpty" :data-source="documents" :columns="getDocumentColumns" :full-page="false" :show-settings="false" :show-selection="false" :show-actions="!attachView" :is-loading="isLoading" :allow-column-edit="false" :allow-inline-edit="false" identifier="sw-order-document-grid" > {% block sw_order_document_card_grid_column_date %} <template #column-createdAt="{ item }"> {% block sw_order_document_card_grid_column_date_label %} {{ dateFilter(item.createdAt, { hour: '2-digit', minute: '2-digit' }) }} {% endblock %} </template> {% endblock %} {% block sw_order_document_card_grid_column_avaiable_formats %} <template #column-fileTypes="{ item }"> {% block sw_order_document_card_grid_column_available_formats_label %} {{ availableFormatsFilter(item) }} {% endblock %} </template> {% endblock %} {% block sw_order_document_card_grid_column_sent %} <template #column-sent="{ item }"> {% block sw_order_document_card_grid_column_sent_label %} <sw-data-grid-column-boolean v-model:value="item.sent" :is-inline-edit="false" /> {% endblock %} </template> {% endblock %} {% block sw_order_document_card_grid_column_attach %} <template v-if="attachView" #column-attach="{ item }" > {% block sw_order_document_card_grid_column_attach_label %} <sw-data-grid-column-boolean v-model:value="item.attach" :is-inline-edit="true" /> {% endblock %} </template> {% endblock %} {% block sw_order_document_card_grid_actions %} <template v-if="!attachView" #actions="{ item }" > {% block sw_order_document_card_grid_action_open %} <sw-context-menu-item :disabled="!acl.can('document.viewer')" class="sw-order-document-card__context-button-open-pdf" @click="onOpenDocument(item.id, item.deepLinkCode)" > {% block sw_order_document_card_grid_action_open_label %} {{ $tc('sw-order.documentCard.labelOpenDocument') }} {% endblock %} </sw-context-menu-item> {% endblock %} {% block sw_order_document_card_grid_action_download %} <sw-context-menu-item :disabled="!acl.can('document.viewer')" class="sw-order-document-card__context-button-download-pdf" @click="onDownload(item.id, item.deepLinkCode)" > {% block sw_order_document_card_grid_action_download_label %} {{ $tc('sw-order.documentCard.labelDownloadPdf') }} {% endblock %} </sw-context-menu-item> {% endblock %} {% block sw_order_document_card_grid_action_send %} <sw-context-menu-item :disabled="!acl.can('document.viewer') || !acl.can('api_send_email')" class="sw-order-document-card__context-button-send" @click="onSendDocument(item.id)" > {% block sw_order_document_card_grid_action_send_label %} {{ $tc('sw-order.documentCard.labelSendDocument') }} {% endblock %} </sw-context-menu-item> {% endblock %} {% block sw_order_document_card_grid_action_mark_sent %} <sw-context-menu-item :disabled="!acl.can('document.viewer') || item.sent" class="sw-order-document-card__context-button-mark-sent" @click="onMarkDocumentAsSent(item.id)" > {% block sw_order_document_card_grid_action_mark_sent_label %} {{ $tc('sw-order.documentCard.labelMarkAsSent') }} {% endblock %} </sw-context-menu-item> {% endblock %} {% block sw_order_document_card_grid_action_mark_unsent %} <sw-context-menu-item :disabled="!acl.can('document.viewer') || !item.sent" class="sw-order-document-card__context-button-mark-unsent" @click="onMarkDocumentAsUnsent(item.id)" > {% block sw_order_document_card_grid_action_mark_unsent_label %} {{ $tc('sw-order.documentCard.labelMarkAsUnsent') }} {% endblock %} </sw-context-menu-item> {% endblock %} </template> {% endblock %} </sw-data-grid> {% endblock %} </template> {% block sw_order_document_card_grid_column_modal %} <div v-if="showModal"> <h1>huhu</h1> <component :is="documentModal" :current-document-type="currentDocumentType" :order="order" :is-loading-document="isLoadingDocument" :is-loading-preview="isLoadingPreview" @loading-document="onLoadingDocument" @loading-preview="onLoadingPreview" @page-leave="onCancelCreation" @document-create="onCreateDocument" @preview-show="onPreview" /> </div> {% endblock %} {% block sw_order_document_card_grid_column_document_type_modal %} <sw-order-select-document-type-modal v-if="showSelectDocumentTypeModal" v-model:value="currentDocumentType" :order="order" @modal-close="onCloseSelectDocumentTypeModal" /> {% endblock %} {% block sw_order_document_card_grid_column_document_send_modal %} <sw-order-send-document-modal v-if="showSendDocumentModal" :document="sendDocument" :order="order" @modal-close="onCloseSendDocumentModal" @document-sent="onDocumentSent" /> {% endblock %} {% block sw_order_document_card_empty_state %} <sw-empty-state v-if="documentsEmpty" :title="emptyStateTitle" :show-description="false" >/ <template #icon> <img :src="assetFilter('/administration/static/img/empty-states/order-empty-state.svg')" :alt="$tc('sw-order.list.messageEmpty')" > </template> <template #actions> <sw-button v-if="showCreateDocumentButton" v-tooltip="{ message: tooltipCreateDocumentButton, disabled: acl.can('document.viewer') && !isEditing, showOnDisabledElements: true }" size="small" variant="ghost" :disabled="!acl.can('document.viewer') || isEditing" class="sw-order-document-grid-button" @click="onShowSelectDocumentTypeModal" > {% block sw_order_document_card_header_create_document_button_label %} {{ $tc('sw-order.documentCard.labelCreateNew') }} {% endblock %} </sw-button> </template> </sw-empty-state> {% endblock %} </sw-card> {% endblock %}`,{Mixin:l,Store:p}=Shopware,{Criteria:r}=Shopware.Data,y={template:w,inject:["documentService","numberRangeService","repositoryFactory","acl"],emits:["update-loading","document-save"],mixins:[l.getByName("listing"),l.getByName("placeholder"),l.getByName("notification")],props:{order:{type:Object,required:!0},isLoading:{type:Boolean,required:!1,default:!1},attachView:{type:Boolean,required:!1,default:!1}},data(){return{documentsLoading:!1,cardLoading:!1,documents:[],documentTypes:null,showModal:!1,currentDocumentType:null,documentNumber:null,documentComment:"",term:"",attachment:{},isLoadingDocument:!1,isLoadingPreview:!1,showSelectDocumentTypeModal:!1,showSendDocumentModal:!1,sendDocument:null}},computed:{isEditing:()=>p.get("swOrderDetail").isEditing,creditItems(){const e=[];return this.order.lineItems.forEach(t=>{t.type==="credit"&&e.push(t)}),e},documentTypeRepository(){return this.repositoryFactory.create("document_type")},documentRepository(){return this.repositoryFactory.create("document")},documentsEmpty(){return this.documents.length===0},documentModal(){const e=this.currentDocumentType.technicalName.replace(/_/g,"-");return this.$.appContext.components[`sw-order-document-settings-${e}-modal`]?`sw-order-document-settings-${e}-modal`:"sw-order-document-settings-modal"},documentCardStyles(){return`sw-order-document-card ${this.documentsEmpty?"sw-order-document-card--is-empty":""}`},documentTypeCriteria(){const e=new r(1,100);return e.addSorting(r.sort("name","ASC")),e},documentCriteria(){const e=new r(this.page,this.limit);return e.addSorting(r.sort("createdAt","DESC")),e.addAssociation("documentType").addAssociation("documentMediaFile").addAssociation("documentA11yMediaFile"),e.addFilter(r.equals("order.id",this.order.id)),this.term&&(e.setTerm(this.term),e.addQuery(r.contains("config.documentDate",this.term),_.HIGH_SEARCH_RANKING),e.addQuery(r.equals("config.documentNumber",this.term),_.HIGH_SEARCH_RANKING)),e},getDocumentColumns(){const e=[{property:"createdAt",dataIndex:"createdAt",label:"sw-order.documentCard.labelDate",allowResize:!1,primary:!0},{property:"config.documentNumber",dataIndex:"config.documentNumber",label:"sw-order.documentCard.labelNumber",allowResize:!1},{property:"documentType.name",dataIndex:"documentType.name",label:"sw-order.documentCard.labelType",allowResize:!1},{property:"sent",dataIndex:"sent",label:"sw-order.documentCard.labelSent",allowResize:!1,align:"center"}];return this.$route.name==="sw.order.detail.documents"&&e.splice(3,0,{property:"fileTypes",dataIndex:"fileTypes",label:"sw-order.documentCard.labelAvailableFormats",allowResize:!1}),this.attachView&&e.push({property:"attach",dataIndex:"attach",label:"sw-order.documentCard.labelAttach",allowResize:!1,align:"center"}),e},isDataLoading(){return this.isLoading||this.documentsLoading||this.cardLoading},showCardFilter(){var e,t;return((t=(e=this.order)==null?void 0:e.documents)==null?void 0:t.length)>0},showCreateDocumentButton(){var e,t;return!((t=(e=this.order)==null?void 0:e.documents)!=null&&t.length)},emptyStateTitle(){var e,t;return((t=(e=this.order)==null?void 0:e.documents)==null?void 0:t.length)>0?this.$tc("sw-order.documentCard.messageNoDocumentFound"):this.$tc("sw-order.documentCard.messageEmptyTitle")},tooltipCreateDocumentButton(){return this.acl.can("document.viewer")?this.$tc("sw-order.documentTab.tooltipSaveBeforeCreateDocument"):this.$tc("sw-privileges.tooltip.warning")},assetFilter(){return Shopware.Filter.getByName("asset")},dateFilter(){return Shopware.Filter.getByName("date")}},watch:{isDataLoading:{handler(e){this.$emit("update-loading",e)}}},created(){this.createdComponent()},methods:{createdComponent(){this.cardLoading=!0,this.documentTypeRepository.search(this.documentTypeCriteria).then(e=>{this.documentTypes=e,this.cardLoading=!1}),this.documentService.setListener(this.convertStoreEventToVueEvent)},convertStoreEventToVueEvent({action:e,payload:t}){if(e===u.DOCUMENT_FAILED){let o=t.detail;t.code==="DOCUMENT__NUMBER_ALREADY_EXISTS"&&(o=this.$tc("sw-order.documentCard.error.DOCUMENT__NUMBER_ALREADY_EXISTS",1,t.meta.parameters||{})),this.createNotificationError({message:o})}else e===u.DOCUMENT_FINISHED&&(this.showModal=!1,this.$nextTick().then(()=>{this.getList().then(()=>{this.$emit("document-save")})}))},getList(){return this.documentsLoading=!0,this.documentRepository.search(this.documentCriteria).then(e=>(this.total=e.total,this.documents=e,this.documentsLoading=!1,Promise.resolve()))},documentTypeAvailable(e){return e.technicalName!=="storno"&&e.technicalName!=="credit_note"||(e.technicalName==="storno"||e.technicalName==="credit_note"&&this.creditItems.length!==0)&&this.invoiceExists()},invoiceExists(){return this.documents.some(e=>e.documentType.technicalName==="invoice")},onSearchTermChange(e){this.term=e,this.getList()},createDocument(e,t,o,n,d){return this.documentService.createDocument(e,t,o,n,{},{},d)},onCancelCreation(){this.showModal=!1,this.currentDocumentType=null},onPrepareDocument(){this.showModal=!0},openDocument(e,t,o){this.documentService.getDocument(e,t,Shopware.Context.api,!0,o).then(n=>{if(n.data){const d=document.createElement("a");d.href=URL.createObjectURL(n.data),d.target="_blank",d.dispatchEvent(new MouseEvent("click")),d.remove()}})},downloadDocument(e,t,o){this.documentService.getDocument(e,t,Shopware.Context.api,!0,o).then(n=>{if(n.data){const d=n.headers["content-disposition"].split("filename=")[1],c=document.createElement("a");c.href=URL.createObjectURL(n.data),c.download=d,c.dispatchEvent(new MouseEvent("click")),c.remove()}})},markDocumentAsSent(e){const t=this.documents.get(e);t.sent=!0,this.documentRepository.save(t).then(()=>{this.getList()})},markDocumentAsUnsent(e){const t=this.documents.get(e);t.sent=!1,this.documentRepository.save(t).then(()=>{this.getList()})},async onCreateDocument(e,t,o=null,n=null){var d,c;this.isLoadingDocument=!0,await this.$nextTick();try{const a=await this.createDocument(this.order.id,this.currentDocumentType.technicalName,e,o,n);if(!a)return;const s=Array.isArray(a)?a[0].documentId:(d=a==null?void 0:a.data)==null?void 0:d.documentId,h=Array.isArray(a)?a[0].documentDeepLink:(c=a==null?void 0:a.data)==null?void 0:c.documentDeepLink;if(e.documentMediaFileId){const i=await this.documentRepository.get(s,Shopware.Context.api);i.documentMediaFileId=e.documentMediaFileId,await this.documentRepository.save(i)}if(t==="download")this.downloadDocument(s,h);else if(t==="send"){const i=new r(null,null);i.addAssociation("documentType").addAssociation("documentA11yMediaFile"),this.documentRepository.get(s,Shopware.Context.api,i).then(m=>{m&&(this.sendDocument=m,this.showSendDocumentModal=!0)})}}finally{this.isLoadingDocument=!1}},onPreview(e,t){return this.isLoadingPreview=!0,this.documentService.getDocumentPreview(this.order.id,this.order.deepLinkCode,this.currentDocumentType.technicalName,e,{fileType:t}).then(o=>{if(o.data){const n=document.createElement("a");n.href=URL.createObjectURL(o.data),n.target="_blank",n.dispatchEvent(new MouseEvent("click")),n.remove()}return o}).finally(()=>{this.isLoadingPreview=!1})},onOpenDocument(e,t,o){this.openDocument(e,t,o)},onDownload(e,t,o){this.downloadDocument(e,t,o)},onSendDocument(e){this.sendDocument=this.documents.get(e),this.showSendDocumentModal=!0},onMarkDocumentAsSent(e){this.markDocumentAsSent(e)},onMarkDocumentAsUnsent(e){this.markDocumentAsUnsent(e)},onCloseSendDocumentModal(){this.sendDocument=null,this.showSendDocumentModal=!1},onDocumentSent(){this.markDocumentAsSent(this.sendDocument.id),this.onCloseSendDocumentModal()},onLoadingDocument(){this.isLoadingDocument=!0},onLoadingPreview(){this.isLoadingPreview=!0},onShowSelectDocumentTypeModal(){this.showSelectDocumentTypeModal=!0},onCloseSelectDocumentTypeModal(e){this.showSelectDocumentTypeModal=!1,e&&this.onPrepareDocument()},availableFormatsFilter(e){var o,n;return[(o=e.documentMediaFile)==null?void 0:o.fileExtension,(n=e.documentA11yMediaFile)==null?void 0:n.fileExtension].filter(d=>d).join(", ").toUpperCase()}}};export{y as default};
