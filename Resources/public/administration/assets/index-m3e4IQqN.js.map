{"version":3,"file":"index-m3e4IQqN.js","sources":["../../../app/administration/src/module/sw-flow/component/modals/sw-flow-rule-modal/sw-flow-rule-modal.html.twig","../../../app/administration/src/module/sw-flow/component/modals/sw-flow-rule-modal/index.js"],"sourcesContent":["<!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n{% block sw_flow_rule_modal %}\n<sw-modal\n    class=\"sw-flow-rule-modal\"\n    variant=\"large\"\n    :title=\"modalTitle\"\n    :is-loading=\"isLoading\"\n    :closable=\"false\"\n    @modal-close=\"onClose\"\n>\n    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n    {% block sw_flow_rule_modal_tabs %}\n    <sw-tabs\n        default-item=\"detail\"\n        position-identifier=\"sw-flow-rule-modal\"\n    >\n        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n        {% block sw_flow_rule_headers %}\n        <template #default=\"{ active }\">\n            <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n            {% block sw_flow_rule_modal_tab_detail %}\n            <sw-tabs-item\n                class=\"sw-flow-rule-modal__tab-detail\"\n                v-bind=\"$props\"\n                name=\"detail\"\n                :active-tab=\"active\"\n            >\n                {{ $tc('sw-flow.modals.rule.tabDetail') }}\n            </sw-tabs-item>\n            {% endblock %}\n\n            <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n            {% block sw_flow_rule_modal_tab_rule %}\n            <sw-tabs-item\n                class=\"sw-flow-rule-modal__tab-rule\"\n                v-bind=\"$props\"\n                name=\"rule\"\n                :active-tab=\"active\"\n            >\n                {{ $tc('sw-flow.modals.rule.tabRule') }}\n            </sw-tabs-item>\n            {% endblock %}\n        </template>\n        {% endblock %}\n\n        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n        {% block sw_flow_rule_modal_content %}\n        <template #content=\"{ active }\">\n            <div class=\"sw-flow-rule-modal__content\">\n                <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                {% block sw_flow_rule_modal_tab_detail_content %}\n                <template v-if=\"active === 'detail' && rule\">\n                    <sw-container\n                        columns=\"2fr 1fr\"\n                        gap=\"0px 32px\"\n                    >\n                        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                        {% block sw_flow_rule_modal_detail_name %}\n                        <sw-text-field\n                            v-model:value=\"rule.name\"\n                            name=\"sw-field--rule-name\"\n                            class=\"sw-flow-rule-modal__name\"\n                            required\n                            :label=\"$tc('sw-flow.modals.rule.labelName')\"\n                            :placeholder=\"$tc('sw-flow.modals.rule.placeholderName')\"\n                            :error=\"ruleNameError\"\n                        />\n                        {% endblock %}\n\n                        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                        {% block sw_flow_rule_modal_detail_priority %}\n                        <sw-number-field\n                            v-model:value=\"rule.priority\"\n                            name=\"sw-field--rule-priority\"\n                            class=\"sw-flow-rule-modal__priority\"\n                            required\n                            :label=\"$tc('sw-flow.modals.rule.labelPriority')\"\n                            :placeholder=\"$tc('sw-flow.modals.rule.placeholderPriority')\"\n                            :error=\"rulePriorityError\"\n                        />\n                    {% endblock %}\n                    </sw-container>\n\n                    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                    {% block sw_flow_rule_modal_detail_description %}\n                    <sw-textarea-field\n                        v-model:value=\"rule.description\"\n                        name=\"sw-field--rule-description\"\n                        class=\"sw-flow-rule-modal__description\"\n                        :label=\"$tc('sw-flow.modals.rule.labelDescription')\"\n                        :placeholder=\"$tc('sw-flow.modals.rule.placeholderDescription')\"\n                    />\n                    {% endblock %}\n\n                    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                    {% block sw_flow_rule_modal_detail_type %}\n                    <sw-multi-select\n                        v-model:value=\"moduleTypes\"\n                        name=\"sw-field--moduleTypes\"\n                        class=\"sw-flow-rule-modal__type\"\n                        value-property=\"id\"\n                        label-property=\"name\"\n                        :label=\"$tc('sw-flow.modals.rule.labelType')\"\n                        :placeholder=\"$tc('sw-flow.modals.rule.placeholderType')\"\n                        :options=\"availableModuleTypes\"\n                    >\n                        <template #selection-label-property=\"{ item }\">\n                            {{ $tc(item.name) }}\n                        </template>\n\n                        <template #result-label-property=\"{ item }\">\n                            {{ $tc(item.name) }}\n                        </template>\n                    </sw-multi-select>\n                    {% endblock %}\n                </template>\n                {% endblock %}\n\n                <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                {% block sw_flow_rule_modal_tab_rule_content %}\n                <div v-show=\"active === 'rule'\">\n                    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n                    {% block sw_flow_rule_modal_conditions_card %}\n                    <sw-condition-tree\n                        v-if=\"conditionRepository\"\n                        class=\"sw-flow-rule-modal__rule\"\n                        association-field=\"ruleId\"\n                        :initial-conditions=\"conditions\"\n                        :condition-repository=\"conditionRepository\"\n                        :condition-data-provider-service=\"ruleConditionDataProviderService\"\n                        :association-value=\"rule.id\"\n                        :association-entity=\"rule\"\n                        :root-condition=\"null\"\n                        @conditions-changed=\"onConditionsChanged\"\n                    />\n                    {% endblock %}\n                </div>\n                {% endblock %}\n            </div>\n        </template>\n        {% endblock %}\n    </sw-tabs>\n    {% endblock %}\n\n    <template #modal-footer>\n        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n        {% block sw_flow_rule_modal_footer_cancel_button %}\n        <sw-button\n            class=\"sw-flow-rule-modal__cancel-button\"\n            size=\"small\"\n            @click=\"onClose\"\n        >\n            {{ $tc('global.default.cancel') }}\n        </sw-button>\n        {% endblock %}\n\n        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n        {% block sw_flow_rule_modal_footer_save_button %}\n        <sw-button-process\n            class=\"sw-flow-rule-modal__save-button\"\n            variant=\"primary\"\n            size=\"small\"\n            :is-loading=\"isSaveLoading\"\n            :process-success=\"isSaveSuccessful\"\n            @click=\"onSaveRule\"\n        >\n            {{ $tc('sw-flow.modals.rule.buttonAddRule') }}\n        </sw-button-process>\n        {% endblock %}\n    </template>\n</sw-modal>\n{% endblock %}\n","import { mapState } from 'vuex';\nimport template from './sw-flow-rule-modal.html.twig';\nimport './sw-flow-rule-modal.scss';\n\nconst { Component, Mixin, Context } = Cicada;\nconst { Criteria } = Cicada.Data;\nconst { mapPropertyErrors } = Component.getComponentHelper();\n\n/**\n * @private\n * @package services-settings\n */\nexport default {\n    template,\n\n    compatConfig: Cicada.compatConfig,\n\n    inject: [\n        'repositoryFactory',\n        'ruleConditionDataProviderService',\n        'ruleConditionsConfigApiService',\n        'feature',\n    ],\n\n    emits: [\n        'process-finish',\n        'modal-close',\n    ],\n\n    mixins: [\n        Mixin.getByName('placeholder'),\n        Mixin.getByName('notification'),\n    ],\n\n    props: {\n        ruleId: {\n            type: String,\n            required: false,\n            default: null,\n        },\n    },\n\n    data() {\n        return {\n            isLoading: false,\n            isSaveLoading: false,\n            isSaveSuccessful: false,\n            rule: null,\n            conditions: null,\n            conditionTree: null,\n            deletedIds: [],\n        };\n    },\n\n    computed: {\n        modalTitle() {\n            return this.ruleId\n                ? this.$tc('sw-flow.modals.rule.labelEditRule')\n                : this.$tc('sw-flow.modals.rule.labelAddNewRule');\n        },\n\n        ruleRepository() {\n            return this.repositoryFactory.create('rule');\n        },\n\n        conditionRepository() {\n            if (!this.rule) {\n                return null;\n            }\n\n            return this.repositoryFactory.create(this.rule?.conditions?.entity, this.rule?.conditions?.source);\n        },\n\n        appScriptConditionRepository() {\n            return this.repositoryFactory.create('app_script_condition');\n        },\n\n        availableModuleTypes() {\n            return this.ruleConditionDataProviderService.getModuleTypes((moduleType) => moduleType);\n        },\n\n        moduleTypes: {\n            get() {\n                if (!this.rule || !this.rule.moduleTypes) {\n                    return [];\n                }\n                return this.rule.moduleTypes.types;\n            },\n\n            set(value) {\n                if (value === null || value.length === 0) {\n                    this.rule.moduleTypes = null;\n                    return;\n                }\n\n                this.rule.moduleTypes = { types: value };\n            },\n        },\n\n        scopesOfRuleAwarenessKey() {\n            const ruleAwarenessKey = `flowTrigger.${this.flow.eventName}`;\n            const awarenessConfig =\n                this.ruleConditionDataProviderService.getAwarenessConfigurationByAssignmentName(ruleAwarenessKey);\n\n            return awarenessConfig?.scopes ?? undefined;\n        },\n\n        ...mapState('swFlowState', ['flow']),\n\n        ...mapPropertyErrors('rule', [\n            'name',\n            'priority',\n        ]),\n    },\n\n    created() {\n        this.createdComponent();\n    },\n\n    methods: {\n        createdComponent() {\n            this.isLoading = true;\n\n            this.loadConditionData().then((scripts) => {\n                this.ruleConditionDataProviderService.addScriptConditions(scripts);\n\n                if (!this.ruleId) {\n                    this.isLoading = false;\n                    this.createRule();\n                    return;\n                }\n\n                this.loadRule(this.ruleId).then(() => {\n                    this.isLoading = false;\n                });\n            });\n        },\n\n        loadConditionData() {\n            const context = {\n                ...Context.api,\n                languageId: Cicada.State.get('session').languageId,\n            };\n            const criteria = new Criteria(1, 500);\n\n            return Promise.all([\n                this.appScriptConditionRepository.search(criteria, context),\n                this.ruleConditionsConfigApiService.load(),\n            ]).then((results) => {\n                return results[0];\n            });\n        },\n\n        createRule() {\n            this.rule = this.ruleRepository.create();\n            this.conditions = this.rule?.conditions;\n            this.conditionTree = this.conditions;\n            this.rule.flowSequences = [];\n            this.rule.flowSequences.push({\n                flow: { eventName: this.flow.eventName },\n            });\n        },\n\n        loadRule(ruleId) {\n            this.isLoading = true;\n            this.conditions = null;\n\n            return this.ruleRepository.get(ruleId, Context.api).then((rule) => {\n                this.rule = rule;\n                this.loadConditions();\n            });\n        },\n\n        loadConditions(conditions = null) {\n            const context = { ...Context.api, inheritance: true };\n\n            if (conditions === null) {\n                return this.conditionRepository.search(new Criteria(1, 25), context).then((searchResult) => {\n                    return this.loadConditions(searchResult);\n                });\n            }\n\n            if (conditions.total <= conditions.length) {\n                this.conditions = conditions;\n                return Promise.resolve();\n            }\n\n            const criteria = new Criteria(conditions.criteria.page + 1, conditions.criteria.limit);\n\n            if (conditions.entity === 'product') {\n                criteria.addAssociation('options.group');\n            }\n\n            return this.conditionRepository.search(criteria, conditions.context).then((searchResult) => {\n                conditions.push(...searchResult);\n                conditions.criteria = searchResult.criteria;\n                conditions.total = searchResult.total;\n\n                return this.loadConditions(conditions);\n            });\n        },\n\n        syncConditions() {\n            return this.conditionRepository.sync(this.conditionTree, Context.api).then(() => {\n                if (this.deletedIds.length > 0) {\n                    return this.conditionRepository.syncDeleted(this.deletedIds, Context.api).then(() => {\n                        this.deletedIds = [];\n                    });\n                }\n                return Promise.resolve();\n            });\n        },\n\n        onConditionsChanged({ conditions, deletedIds }) {\n            this.conditionTree = conditions;\n            this.deletedIds = [\n                ...this.deletedIds,\n                ...deletedIds,\n            ];\n        },\n\n        getRuleDetail() {\n            if (!this.rule?.id) {\n                return null;\n            }\n\n            return this.ruleRepository\n                .get(this.rule.id)\n                .then((rule) => {\n                    this.$emit('process-finish', rule);\n                })\n                .catch(() => {\n                    this.$emit('process-finish', null);\n                })\n                .finally(() => {\n                    this.onClose();\n                });\n        },\n\n        onSaveRule() {\n            this.isSaveSuccessful = false;\n            this.isSaveLoading = true;\n\n            if (this.rule.isNew()) {\n                this.rule.flowSequences = [];\n                this.rule.conditions = this.conditionTree;\n\n                this.saveRule()\n                    .then(() => {\n                        Cicada.State.dispatch('error/resetApiErrors');\n                        this.getRuleDetail();\n\n                        this.isSaveSuccessful = true;\n                    })\n                    .catch(() => {\n                        this.showErrorNotification();\n                    })\n                    .finally(() => {\n                        this.isSaveLoading = false;\n                    });\n\n                return;\n            }\n\n            this.saveRule()\n                .then(this.syncConditions)\n                .then(() => {\n                    Cicada.State.dispatch('error/resetApiErrors');\n                    this.getRuleDetail();\n\n                    this.isSaveSuccessful = true;\n                })\n                .catch(() => {\n                    this.showErrorNotification();\n                })\n                .finally(() => {\n                    this.isSaveLoading = false;\n                });\n        },\n\n        saveRule() {\n            return this.ruleRepository.save(this.rule, Context.api);\n        },\n\n        showErrorNotification() {\n            this.createNotificationError({\n                message: this.$tc('sw-settings-rule.detail.messageSaveError', 0, { name: this.rule.name }),\n            });\n        },\n\n        onClose() {\n            this.$emit('modal-close');\n        },\n    },\n};\n"],"names":["template","Component","Mixin","Context","Criteria","mapPropertyErrors","index","_b","_a","_d","_c","moduleType","value","ruleAwarenessKey","awarenessConfig","mapState","scripts","context","criteria","results","ruleId","rule","conditions","searchResult","deletedIds"],"mappings":"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"}