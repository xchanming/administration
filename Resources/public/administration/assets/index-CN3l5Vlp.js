Shopware.Store.register({id:"swSeoUrl",state(){return{salesChannelCollection:null,seoUrlCollection:null,originalSeoUrls:[],defaultSeoUrl:null,currentSeoUrl:null}},getters:{newOrModifiedUrls(){var t;const e=[];return(t=this.seoUrlCollection)==null||t.forEach(l=>{if(l.seoPathInfo===null)return;const o=this.originalSeoUrls.find(s=>s.id===l.id);o&&o.seoPathInfo===l.seoPathInfo||!o&&!l.seoPathInfo||e.push(l)}),e}}});const h=`{% block sw_seo_url %} <div class="sw-seo-url"> <sw-card class="sw-seo-url__card" position-identifier="sw-seo-url" :title="$tc('sw-seo-url.titleCard')" :is-loading="isLoading" > {% block sw_seo_url_card %} <template v-if="showEmptySeoUrlError"> {{ $tc('sw-seo-url.textEmptySeoUrls') }} </template> <template v-else> {% block sw_seo_url_card_seo_path %} <sw-inherit-wrapper v-model:value="currentSeoUrl.seoPathInfo" :has-parent="currentSalesChannelId !== null && !isHeadlessSalesChannel && hasDefaultTemplate" :inherited-value="(currentSeoUrl.salesChannelId !== null && !isHeadlessSalesChannel) ? defaultSeoUrl.seoPathInfo : null" > <template #content="props"> {% block sw_seo_url_card_seo_path_edit %} <sw-text-field :map-inheritance="props" :value="props.currentValue" :disabled="props.isInherited || isHeadlessSalesChannel || !allowInput" :disable-inheritance-toggle="isHeadlessSalesChannel" :label="$tc('sw-seo-url.labelSeoPathInfo')" :help-text="seoUrlHelptext" @update:value="props.updateCurrentValue" /> {% endblock %} </template> </sw-inherit-wrapper> {% endblock %} </template> {% block sw_seo_url_card_toolbar %} <template v-if="!showEmptySeoUrlError" #toolbar > <sw-sales-channel-switch ref="salesChannelSwitch" :disabled="disabled || undefined" :label="$tc('sw-seo-url.labelSalesChannelSelect')" @change-sales-channel-id="onSalesChannelChanged" /> </template> {% endblock %} <div v-if="hasAdditionalSeoSlot" class="sw-seo-url__card-seo-additional" > <slot name="seo-additional" v-bind="{currentSalesChannelId}" > {% block sw_seo_url_additional %}{% endblock %} </slot> </div> {% endblock %} </sw-card> </div> {% endblock %}`,i=Shopware.Data.Criteria,u=Shopware.Data.EntityCollection,d={template:h,inject:["repositoryFactory"],emits:["on-change-sales-channel"],mixins:[],props:{salesChannelId:{type:String,required:!1,default:null},urls:{type:Array,required:!1,default(){return[]}},isLoading:{type:Boolean,required:!1,default:!1},hasDefaultTemplate:{type:Boolean,required:!1,default:!0},disabled:{type:Boolean,required:!1,default:!1},resultLimit:{type:Number,required:!1,default:25}},data(){return{currentSalesChannelId:this.salesChannelId,showEmptySeoUrlError:!1}},computed:{seoUrlCollection(){return Shopware.Store.get("swSeoUrl").seoUrlCollection},currentSeoUrl(){return Shopware.Store.get("swSeoUrl")?Shopware.Store.get("swSeoUrl").currentSeoUrl:{}},defaultSeoUrl(){return Shopware.Store.get("swSeoUrl").defaultSeoUrl},seoUrlRepository(){return this.repositoryFactory.create("seo_url")},salesChannelRepository(){return this.repositoryFactory.create("sales_channel")},isHeadlessSalesChannel(){if(!Shopware.Store.get("swSeoUrl")||Shopware.Store.get("swSeoUrl").salesChannelCollection===null)return!0;const e=Shopware.Store.get("swSeoUrl").salesChannelCollection.find(t=>t.id===this.currentSalesChannelId);return this.currentSalesChannelId!==null&&(e==null?void 0:e.typeId)==="f183ee5650cf4bdb8a774337575067a6"},seoUrlHelptext(){return this.isHeadlessSalesChannel?this.$tc("sw-seo-url.textSeoUrlsDisallowedForHeadless"):null},hasAdditionalSeoSlot(){return this.$slots.hasOwnProperty("seo-additional")},allowInput(){return this.hasDefaultTemplate||this.currentSalesChannelId!==null}},watch:{urls(){this.initSeoUrlCollection(),this.refreshCurrentSeoUrl()}},created(){Shopware.Utils.EventBus.on("sw-product-detail-save-finish",this.clearDefaultSeoUrls),this.createdComponent()},beforeUnmount(){Shopware.Utils.EventBus.off("sw-product-detail-save-finish",this.clearDefaultSeoUrls)},methods:{createdComponent(){this.initSalesChannelCollection(),this.initSeoUrlCollection(),this.showEmptySeoUrlError||this.refreshCurrentSeoUrl()},initSalesChannelCollection(){const e=new i(1,this.resultLimit);e.addAssociation("type"),this.salesChannelRepository.search(e).then(t=>{Shopware.Store.get("swSeoUrl").salesChannelCollection=t})},initSeoUrlCollection(){this.showEmptySeoUrlError=!1;const e=new u(this.seoUrlRepository.route,this.seoUrlRepository.schema.entity,Shopware.Context.api,new i(1,this.resultLimit)),t=this.urls.find(o=>o.salesChannelId===null);t===void 0&&(this.hasDefaultTemplate||this.urls.length<=0)&&(this.showEmptySeoUrlError=!0);const l=this.seoUrlRepository.create();Object.assign(l,t),e.add(l),Shopware.Store.get("swSeoUrl").defaultSeoUrl=l,this.urls.forEach(o=>{const s=this.seoUrlRepository.create();Object.assign(s,o),e.add(s)}),Shopware.Store.get("swSeoUrl").defaultSeoUrl||(this.showEmptySeoUrlError=!0),Shopware.Store.get("swSeoUrl").seoUrlCollection=e,Shopware.Store.get("swSeoUrl").originalSeoUrls=this.urls,this.clearDefaultSeoUrls()},clearDefaultSeoUrls(){this.seoUrlCollection.forEach(e=>{e.id!==this.defaultSeoUrl.id&&e.seoPathInfo===this.defaultSeoUrl.seoPathInfo&&(e.seoPathInfo=null)})},refreshCurrentSeoUrl(){var l,o,s;const e=Shopware.Context.api.languageId,t=this.seoUrlCollection.find(r=>r.languageId===e&&r.salesChannelId===this.currentSalesChannelId);if(!t){const r=this.seoUrlRepository.create(),a=this.seoUrlCollection.find(n=>n.pathInfo&&n.routeName&&n.foreignKey)||{};r.foreignKey=((l=this.defaultSeoUrl)==null?void 0:l.foreignKey)??a.foreignKey,r.isCanonical=!0,r.languageId=e,r.salesChannelId=this.currentSalesChannelId,r.routeName=((o=this.defaultSeoUrl)==null?void 0:o.routeName)??a.routeName,r.pathInfo=((s=this.defaultSeoUrl)==null?void 0:s.pathInfo)??a.pathInfo,r.isModified=!0,this.seoUrlCollection.add(r),Shopware.Store.get("swSeoUrl").currentSeoUrl=r;return}Shopware.Store.get("swSeoUrl").currentSeoUrl=t},onSalesChannelChanged(e){this.currentSalesChannelId=e,this.$emit("on-change-sales-channel",e),this.refreshCurrentSeoUrl()}}};export{d as default};
