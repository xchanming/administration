const{Context:d}=Cicada,{Criteria:a}=Cicada.Data;function u(t,i){const s={product:{id:"product",associationName:"productPrices",notAssignedDataTotal:0,allowAdd:!1,entityName:"product",label:"sw-settings-rule.detail.associations.products",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("prices.rule.id",t)),e.addAssociation("options.group"),e},api:()=>{const e={...d.api};return e.inheritance=!0,e},detailRoute:"sw.product.detail.prices",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.product.detail.prices",allowEdit:!1}]},shipping_method_availability_rule:{id:"shipping_method_availability_rule",associationName:"shippingMethods",notAssignedDataTotal:0,allowAdd:!0,entityName:"shipping_method",label:"sw-settings-rule.detail.associations.shippingMethodAvailabilityRule",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("availabilityRuleId",t)),e},detailRoute:"sw.settings.shipping.detail",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.settings.shipping.detail",allowEdit:!1}],addContext:{type:"one-to-many",entity:"shipping_method",column:"availabilityRuleId",searchColumn:"name",criteria:()=>{const e=new a(1,25);return e.addFilter(a.not("AND",[a.equals("availabilityRuleId",t)])),e},gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,allowEdit:!1},{property:"description",label:"Description",rawData:!0,sortable:!0,allowEdit:!1},{property:"taxType",label:"Tax calculation",rawData:!0,sortable:!0,allowEdit:!1},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1}]}},shipping_method_prices:{id:"shipping_method_prices",associationName:"shippingMethodPrices",notAssignedDataTotal:0,allowAdd:!1,entityName:"shipping_method",label:"sw-settings-rule.detail.associations.shippingMethodPrices",criteria:()=>{const e=new a(1,i);return e.addFilter(a.multi("OR",[a.equals("prices.ruleId",t),a.equals("prices.calculationRuleId",t)])),e},detailRoute:"sw.settings.shipping.detail",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.settings.shipping.detail",allowEdit:!1}]},tax_provider:{id:"tax_provider",notAssignedDataTotal:0,allowAdd:!0,entityName:"tax_provider",label:"sw-settings-rule.detail.associations.taxProviders",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("availabilityRuleId",t)),e},detailRoute:"sw.settings.tax.tax_provider.detail",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.settings.tax.tax_provider.detail"},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1}],addContext:{type:"one-to-many",entity:"tax_provider",column:"availabilityRuleId",searchColumn:"name",criteria:()=>{const e=new a(1,25);return e.addFilter(a.not("AND",[a.equals("availabilityRuleId",t)])),e},gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,allowEdit:!1},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1}]}},payment_method:{id:"payment_method",associationName:"paymentMethods",notAssignedDataTotal:0,allowAdd:!0,entityName:"payment_method",label:"sw-settings-rule.detail.associations.paymentMethods",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("availabilityRuleId",t)),e},detailRoute:"sw.settings.payment.detail",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.settings.payment.detail",allowEdit:!1}],deleteContext:{type:"one-to-many",entity:"payment_method",column:"availabilityRuleId"},addContext:{type:"one-to-many",entity:"payment_method",column:"availabilityRuleId",searchColumn:"name",criteria:()=>{const e=new a(1,25);return e.addFilter(a.not("AND",[a.equals("availabilityRuleId",t)])),e},gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,allowEdit:!1},{property:"extension",label:"Extension",rawData:!0,sortable:!0,allowEdit:!1},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1},{property:"position",label:"Position",rawData:!0,sortable:!0,allowEdit:!1}]}},promotion_order_rule:{id:"promotion_order_rule",associationName:"orderPromotions",notAssignedDataTotal:0,allowAdd:!0,entityName:"promotion",label:"sw-settings-rule.detail.associations.promotionOrderRules",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("orderRules.id",t)),e.addAssociation("orderRules"),e},detailRoute:"sw.promotion.v2.detail.conditions",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.promotion.v2.detail.conditions"}],deleteContext:{type:"many-to-many",entity:"promotion",column:"orderRules"},addContext:{type:"many-to-many",entity:"promotion_order_rule",column:"promotionId",searchColumn:"name",association:"orderRules",criteria:()=>{const e=new a(1,25);return e.addFilter(a.not("AND",[a.equals("orderRules.id",t)])),e},gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,allowEdit:!1},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1},{property:"validFrom",label:"Valid from",rawData:!0,sortable:!0,allowEdit:!1},{property:"validTo",label:"Valid to",rawData:!0,sortable:!0,allowEdit:!1}]}},promotion_customer_rule:{id:"promotion_customer_rule",associationName:"personaPromotions",notAssignedDataTotal:0,allowAdd:!0,entityName:"promotion",label:"sw-settings-rule.detail.associations.promotionCustomerRules",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("personaRules.id",t)),e.addAssociation("personaRules"),e},detailRoute:"sw.promotion.v2.detail.conditions",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.promotion.v2.detail.conditions"}],deleteContext:{type:"many-to-many",entity:"promotion",column:"personaRules"},addContext:{type:"many-to-many",entity:"promotion_persona_rule",column:"promotionId",searchColumn:"name",association:"personaRules",criteria:()=>{const e=new a(1,25);return e.addFilter(a.not("AND",[a.equals("personaRules.id",t)])),e},gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,allowEdit:!1},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1},{property:"validFrom",label:"Valid from",rawData:!0,sortable:!0,allowEdit:!1},{property:"validTo",label:"Valid to",rawData:!0,sortable:!0,allowEdit:!1}]}},promotion_cart_rule:{id:"promotion_cart_rule",associationName:"cartPromotions",notAssignedDataTotal:0,allowAdd:!0,entityName:"promotion",label:"sw-settings-rule.detail.associations.promotionCartRules",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("cartRules.id",t)),e.addAssociation("cartRules"),e},detailRoute:"sw.promotion.v2.detail.conditions",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.promotion.v2.detail.conditions"}],deleteContext:{type:"many-to-many",entity:"promotion",column:"cartRules"},addContext:{type:"many-to-many",entity:"promotion_cart_rule",column:"promotionId",searchColumn:"name",association:"cartRules",criteria:()=>{const e=new a(1,25);return e.addFilter(a.not("AND",[a.equals("cartRules.id",t)])),e},gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,allowEdit:!1},{property:"active",label:"Active",rawData:!0,sortable:!0,allowEdit:!1},{property:"validFrom",label:"Valid from",rawData:!0,sortable:!0,allowEdit:!1},{property:"validTo",label:"Valid to",rawData:!0,sortable:!0,allowEdit:!1}]}},promotion_discount_rule:{id:"promotion_discount_rule",associationName:"promotionDiscounts",notAssignedDataTotal:0,allowAdd:!1,entityName:"promotion",label:"sw-settings-rule.detail.associations.promotionDiscountRules",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("discounts.discountRules.id",t)),e},detailRoute:"sw.promotion.v2.detail.conditions",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.promotion.v2.detail.conditions"}]},promotion_group_rule:{id:"promotion_group_rule",associationName:"promotionSetGroups",notAssignedDataTotal:0,allowAdd:!1,entityName:"promotion",label:"sw-settings-rule.detail.associations.promotionGroupRules",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("setgroups.setGroupRules.id",t)),e},detailRoute:"sw.promotion.v2.detail.conditions",gridColumns:[{property:"name",label:"Name",rawData:!0,sortable:!0,routerLink:"sw.promotion.v2.detail.conditions"}]},flow:{id:"flow",notAssignedDataTotal:0,allowAdd:!1,entityName:"flow",label:"sw-settings-rule.detail.associations.flows",criteria:()=>{const e=new a(1,i);return e.addFilter(a.equals("sequences.rule.id",t)),e},detailRoute:"sw.flow.detail",gridColumns:[{property:"name",label:"Flow",rawData:!0,sortable:!0,width:"50%",routerLink:"sw.flow.detail"},{property:"eventName",label:"Trigger",rawData:!0,sortable:!0,width:"50%",routerLink:!1}]}};function o(){return s}return{getConfiguration:o}}const c=`{% block sw_settings_rule_detail_assignments %} <div class="sw-settings-rule-detail-assignments"> {% block sw_settings_rule_detail_assignments_entity_cards %} <sw-card v-for="entity in associationEntities" :key="entity.id" class="sw-settings-rule-detail-assignments__card" position-identifier="sw-settings-rule-detail-assignments-entity" :class="\`sw-settings-rule-detail-assignments__card-\${entity.id}\`" :title="$tc(entity.label)" > <template #toolbar> {% block sw_settings_rule_detail_assignments_toolbar %} <sw-card-filter placeholder="" @sw-card-filter-term-change="onFilterEntity(entity, $event)" > <template #filter> {% block sw_settings_rule_detail_assignments_add_button %} <sw-button v-if="entity.allowAdd" v-tooltip="getTooltipConfig(entity)" :disabled="disableAdd(entity) || !acl.can('rule.editor')" variant="ghost" size="small" class="sw-settings-rule-detail-assignments__add-button" @click="onOpenAddModal(entity)" > {{ $tc('sw-settings-rule.detail.buttonAddAssignment') }} </sw-button> {% endblock %} </template> </sw-card-filter> {% endblock %} </template> <template #grid> {% block sw_settings_rule_detail_assignments_entity_listing %} <sw-settings-rule-assignment-listing v-if="entity.loadedData && entity.loadedData.length > 0" class="sw-settings-rule-detail-assignments__entity-listing" :class="\`sw-settings-rule-detail-assignments__entity-listing-\${entity.id}\`" :is-loading="isLoading" :detail-route="entity.detailRoute" :items="entity.loadedData" :repository="entity.repository" :local-mode="false" :criteria-limit="5" :allow-delete="allowDeletion(entity) && acl.can('rule.editor')" :allow-inline-edit="false" :show-settings="false" :show-selection="allowDeletion(entity) && acl.can('rule.editor')" :allow-column-edit="false" :steps="associationSteps" :columns="entity.gridColumns" :full-page="false" @delete-items="(event) => onDeleteItems(entity, event)" > <template #link-column="{ item, column, renderColumn }"> <router-link v-if="column.routerLink" :to="getRouterLink(entity, item)" > <sw-product-variant-info v-if="item.variation" :variations="item.variation" > {{ renderColumn(item, column) }} </sw-product-variant-info> <span v-if="!item.variation"> {{ renderColumn(item, column) }} </span> </router-link> <span v-else> <sw-product-variant-info v-if="item.variation" :variations="item.variation" > {{ renderColumn(item, column) }} </sw-product-variant-info> <span v-else> {{ renderColumn(item, column) }} </span> </span> </template> <template #actions="{ item }"> {% block sw_settings_rule_detail_assignments_entity_listing_actions %} {% block sw_settings_rule_detail_assignments_entity_listing_view_action %} <sw-context-menu-item :router-link="getRouterLink(entity, item)"> {{ $tc('global.default.view') }} </sw-context-menu-item> {% endblock %} {% block sw_settings_rule_detail_assignments_entity_listing_delete_action %} <sw-context-menu-item v-if="entity.deleteContext && acl.can('rule.editor')" variant="danger" @click="onOpenDeleteModal(entity, item)" > {{ $tc('global.default.remove') }} </sw-context-menu-item> {% endblock %} {% endblock %} </template> <template #bulk-modal-delete-confirm-text="{ selectionCount }"> {{ $tc('sw-settings-rule.detail.textModalBulkDelete', selectionCount, { count: selectionCount }) }} </template> <template #bulk-modal-delete-items="{ isBulkLoading, deleteItems }"> <sw-button variant="danger" size="small" :is-loading="isBulkLoading" @click="deleteItems" > {{ $tc('global.default.remove') }} </sw-button> </template> </sw-settings-rule-assignment-listing> {% block sw_settings_rule_detail_assignments_empty_state %} <sw-empty-state v-else class="sw-settings-rule-detail-assignments__entity-empty-state" :class="\`sw-settings-rule-detail-assignments__entity-empty-state-\${entity.id}\`" :title="$tc('sw-settings-rule.detail.hasNoAssociations')" :absolute="false" :show-description="false" > <template #icon> <img :src="assetFilter('administration/static/img/empty-states/settings-empty-state.svg')" :alt="$tc('sw-settings-rule.detail.hasNoAssociations')" > </template> </sw-empty-state> {% endblock %} {% endblock %} </template> </sw-card> {% endblock %} {% block sw_settings_rule_detail_assignments_delete_modal %} <sw-modal v-if="deleteModal" class="sw-settings-rule-detail-assignments__delete-modal" :title="$tc('sw-settings-rule.detail.titleModalDelete')" variant="small" @modal-close="onCloseDeleteModal" > {% block sw_settings_rule_detail_assignments_delete_modal_text %} <p class="sw-settings-rule-detail-assignments__delete-text"> {{ $tc('sw-settings-rule.detail.textModalDelete') }} </p> {% endblock %} {% block sw_settings_rule_detail_assignments_delete_modal_footer %} <template #modal-footer> {% block sw_settings_rule_detail_assignments_delete_modal_cancel %} <sw-button class="sw-settings-rule-detail-assignments__delete-modal-cancel-button" size="small" @click="onCloseDeleteModal" > {{ $tc('global.default.cancel') }} </sw-button> {% endblock %} {% block sw_settings_rule_detail_assignments_delete_modal_confirm %} {% block sw_settings_rule_detail_assignments_delete_modal_confirm_single %} <sw-button class="sw-settings-rule-detail-assignments__delete-modal-delete-button" size="small" variant="danger" @click="onDelete" > {{ $tc('global.default.remove') }} </sw-button> {% endblock %} {% endblock %} </template> {% endblock %} </sw-modal> {% endblock %} {% block sw_settings_rule_detail_assignments_add_modal %} <sw-settings-rule-add-assignment-modal v-if="addModal" :rule="rule" :entity-context="addEntityContext" @entities-saved="onEntitiesSaved" @close-add-modal="onCloseAddModal" /> {% endblock %} </div> {% endblock %}`,{Mixin:m,Context:l,Utils:n}=Cicada,{Criteria:r}=Cicada.Data,p={template:c,compatConfig:Cicada.compatConfig,inject:["repositoryFactory","ruleConditionDataProviderService","feature","acl"],mixins:[m.getByName("notification")],props:{rule:{type:Object,required:!0},conditions:{type:Array,required:!1,default:null},detailPageLoading:{type:Boolean,required:!1,default:!1}},data(){return{associationLimit:5,isLoading:!1,ruleAssociationsLoaded:!1,products:null,shippingMethods:null,paymentMethods:null,promotions:null,associationSteps:[5,10],associationEntities:null,deleteModal:!1,deleteEntity:null,deleteItem:null,addModal:!1,addEntityContext:null}},computed:{getRuleAssignmentConfiguration(){return u(this.rule.id,this.associationLimit).getConfiguration()},associationEntitiesConfig(){return Object.values(this.getRuleAssignmentConfiguration)},assetFilter(){return Cicada.Filter.getByName("asset")}},created(){this.createdComponent()},methods:{createdComponent(){this.prepareAssociationEntitiesList(),this.loadAssociationData()},disableAdd(t){const i=t.associationName??null;return this.ruleConditionDataProviderService.isRuleRestricted(this.conditions,i)?!0:t.notAssignedDataTotal===0},getTooltipConfig(t){const i=t.associationName??null;return this.ruleConditionDataProviderService.getRestrictedRuleTooltipConfig(this.conditions,i)},allowDeletion(t){return!!t.deleteContext},prepareAssociationEntitiesList(){this.associationEntities=this.associationEntitiesConfig.map(t=>({repository:this.repositoryFactory.create(t.entityName),loadedData:null,...t}))},onOpenDeleteModal(t,i){this.deleteModal=!0,this.deleteEntity=t,this.deleteItem=i},onCloseDeleteModal(){this.deleteModal=!1,this.deleteContext=null,this.deleteItem=null},onOpenAddModal(t){this.addModal=!0,this.addEntityContext=t},onCloseAddModal(){this.addModal=!1,this.addEntityContext=null},onEntitiesSaved(){return this.addModal=!1,this.refreshAssignmentData(this.addEntityContext)},async onDeleteItems(t,i){return await Promise.all(Object.values(i).map(async s=>{this.deleteEntity=t,this.deleteItem=s,await this.doDeleteItem()})),this.refreshAssignmentData(t).then(()=>{this.onCloseDeleteModal()})},onDelete(){return this.doDeleteItem().then(()=>this.refreshAssignmentData(this.deleteEntity).then(()=>{this.onCloseDeleteModal()}))},doDeleteItem(){const t=this.deleteEntity.api?this.deleteEntity.api():l.api,i=this.repositoryFactory.create(this.deleteItem.getEntityName());return this.deleteEntity.deleteContext.type==="one-to-many"?n.object.set(this.deleteItem,this.deleteEntity.deleteContext.column,null):n.object.get(this.deleteItem,this.deleteEntity.deleteContext.column).remove(this.rule.id),this.isLoading=!0,i.save(this.deleteItem,t).finally(()=>{this.isLoading=!1})},async refreshAssignmentData(t){this.isLoading=!0;const i=t.api?t.api():l.api,s=await t.repository.search(t.criteria(),i),o=await this.loadNotAssignedDataTotals(t,i);this.associationEntities.forEach(e=>{t.id===e.id&&(e.loadedData=s,e.notAssignedDataTotal=o)}),this.isLoading=!1},onFilterEntity(t,i){const s=t.api?t.api():l.api,o=t.criteria();return o.setPage(1),o.setTerm(i),this.isLoading=!0,t.repository.search(o,s).then(e=>{t.loadedData=e}).finally(()=>{this.isLoading=!1})},async loadNotAssignedDataTotals(t,i){if(!t.deleteContext&&!t.addContext)return Promise.resolve(t.notAssignedDataTotal);const s=new r(1,1);return s.addFilter(r.not("AND",t.criteria().filters)),this.isLoading=!0,t.repository.search(s,i).then(o=>Promise.resolve(o.total)).finally(()=>{this.isLoading=!1})},getRouterLink(t,i){return{name:t.detailRoute,params:{id:i.id}}},loadAssociationData(){return this.isLoading=!0,Promise.all(this.associationEntities.map(t=>{const i=t.api?t.api():l.api;return t.repository.search(t.criteria(),i).then(async s=>{t.loadedData=s,t.notAssignedDataTotal=await this.loadNotAssignedDataTotals(t,i)})})).catch(()=>{this.createNotificationError({message:this.$tc("sw-settings-rule.detail.associationsLoadingError")})}).finally(()=>{this.isLoading=!1})}}};export{p as default};
//# sourceMappingURL=index-DgV_VkMU.js.map
