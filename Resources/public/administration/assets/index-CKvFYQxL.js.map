{"version":3,"file":"index-CKvFYQxL.js","sources":["../../../app/administration/src/module/sw-order/component/sw-order-details-state-card/sw-order-details-state-card.html.twig","../../../app/administration/src/module/sw-order/component/sw-order-details-state-card/index.js"],"sourcesContent":["<!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n{% block sw_order_detail_state_card %}\n<sw-card\n    class=\"sw-order-detail-state-card\"\n    position-identifier=\"sw-order-details-state\"\n    :title=\"title\"\n    :is-loading=\"isLoading\"\n>\n\n    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n    {% block sw_order_detail_state_card_state %}\n    <div class=\"sw-order-detail-state-card__state\">\n        <sw-container\n            class=\"sw-order-detail-state-card__state-container\"\n            gap=\"16px\"\n            columns=\"33% auto auto\"\n        >\n\n            <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n            {% block sw_order_detail_state_card_state_select %}\n            <sw-order-state-select-v2\n                v-tooltip=\"{\n                    message: $tc('sw-privileges.tooltip.warning'),\n                    disabled: acl.can('order.editor'),\n                    showOnDisabledElements: true\n                }\"\n                :transition-options=\"stateOptions\"\n                :state-type=\"entityName\"\n                rounded-style\n                :placeholder=\"entity.stateMachineState.translated.name\"\n                :label=\"stateLabel\"\n                :background-style=\"stateSelectBackgroundStyle\"\n                :disabled=\"disabled\"\n                :is-loading=\"statesLoading\"\n                @state-select=\"onStateSelected\"\n            />\n            {% endblock %}\n\n            <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n            {% block sw_order_detail_state_card_state_history_text %}\n            <div\n                v-if=\"lastStateChange\"\n                class=\"sw-order-detail-state-card__state-history-text\"\n            >\n                <i18n-t\n                    keypath=\"sw-order.stateCard.labelHistory\"\n                >\n                    <template #time>\n                        <sw-time-ago :date=\"lastStateChange.createdAt\" />\n                    </template>\n                    <template #author>\n                        {{ lastStateChange.user ? lastStateChange.user.name : $tc('sw-order.stateCard.labelSystemUser') }}\n                    </template>\n                </i18n-t>\n            </div>\n            <div v-else></div>\n            {% endblock %}\n\n            <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n            {% block sw_order_detail_state_card_state_history_button %}\n            <sw-external-link\n                class=\"sw-order-detail-state-card__state-history-button\"\n                icon=\"regular-long-arrow-right\"\n                @click=\"onShowStatusHistory\"\n            >\n                {{ $tc('sw-order.stateCard.labelShowHistoryModal') }}\n            </sw-external-link>\n            {% endblock %}\n\n        </sw-container>\n\n        <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n        {% block sw_order_state_change_card_state_modal %}\n        <sw-order-state-change-modal\n            v-if=\"showStateChangeModal\"\n            :order=\"order\"\n            :is-loading=\"isLoading\"\n            :technical-name=\"''\"\n            @page-leave=\"onLeaveModalClose\"\n            @page-leave-confirm=\"onLeaveModalConfirm\"\n        />\n        {% endblock %}\n    </div>\n    {% endblock %}\n\n    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n    {% block sw_order_state_change_card_divider %}\n    <hr class=\"sw-order-detail-state-card__divider\">\n    {% endblock %}\n\n    <!-- eslint-disable-next-line sw-deprecation-rules/no-twigjs-blocks -->\n    {% block sw_order_state_change_card_content %}\n    <sw-container\n        class=\"sw-order-detail-state-card__content\"\n        columns=\"1fr 1fr\"\n    >\n        <slot></slot>\n    </sw-container>\n    {% endblock %}\n\n</sw-card>\n{% endblock %}\n","import template from './sw-order-details-state-card.html.twig';\nimport './sw-order-details-state-card.scss';\n\n/**\n * @package checkout\n */\n\nconst { Criteria } = Cicada.Data;\n\n// eslint-disable-next-line sw-deprecation-rules/private-feature-declarations\nexport default {\n    template,\n\n    compatConfig: Cicada.compatConfig,\n\n    inject: [\n        'acl',\n        'repositoryFactory',\n        'orderStateMachineService',\n        'stateMachineService',\n        'stateStyleDataProviderService',\n    ],\n\n    emits: [\n        'show-status-history',\n        'save-edits',\n    ],\n\n    mixins: [\n        'notification',\n    ],\n\n    props: {\n        order: {\n            type: Object,\n            required: true,\n        },\n        title: {\n            type: String,\n            required: false,\n            default: '',\n        },\n        entity: {\n            type: Object,\n            required: true,\n        },\n        stateLabel: {\n            type: String,\n            required: false,\n            default: '',\n        },\n        isLoading: {\n            type: Boolean,\n            required: false,\n            default: false,\n        },\n        disabled: {\n            type: Boolean,\n            required: false,\n            default: false,\n        },\n    },\n\n    data() {\n        return {\n            statesLoading: false,\n            stateOptions: [],\n            lastStateChange: null,\n            currentActionName: null,\n            showStateChangeModal: false,\n            stateChangeModalConfirmed: false,\n        };\n    },\n\n    computed: {\n        stateMachineStateRepository() {\n            return this.repositoryFactory.create('state_machine_state');\n        },\n\n        stateMachineHistoryRepository() {\n            return this.repositoryFactory.create('state_machine_history');\n        },\n\n        stateMachineStateCriteria() {\n            const criteria = new Criteria(1, null);\n            criteria.addSorting({ field: 'name', order: 'ASC' });\n            criteria.addAssociation('stateMachine');\n            criteria.addFilter(\n                Criteria.equals('state_machine_state.stateMachine.technicalName', `${this.entityName}.state`),\n            );\n\n            return criteria;\n        },\n\n        stateMachineHistoryCriteria() {\n            const criteria = new Criteria(1, 1);\n\n            criteria.addFilter(Criteria.equals('referencedId', this.entity.id));\n            criteria.addFilter(Criteria.equals('entityName', this.entityName));\n            criteria.addAssociation('user');\n            criteria.addSorting({ field: 'createdAt', order: 'DESC' });\n\n            return criteria;\n        },\n\n        entityName() {\n            return this.entity.getEntityName();\n        },\n\n        stateName() {\n            return this.entity.stateMachineState.translated.name;\n        },\n\n        stateSelectBackgroundStyle() {\n            const technicalName = this.entity.stateMachineState.technicalName;\n\n            return this.stateStyleDataProviderService.getStyle(`${this.entityName}.state`, technicalName)\n                .selectBackgroundStyle;\n        },\n\n        stateTransitionMethod() {\n            switch (this.entityName) {\n                case 'order':\n                    return this.orderStateMachineService.transitionOrderState.bind(this.orderStateMachineService);\n                case 'order_transaction':\n                    return this.orderStateMachineService.transitionOrderTransactionState.bind(this.orderStateMachineService);\n                case 'order_delivery':\n                    return this.orderStateMachineService.transitionOrderDeliveryState.bind(this.orderStateMachineService);\n                default:\n                    return null;\n            }\n        },\n    },\n\n    created() {\n        this.createdComponent();\n    },\n\n    methods: {\n        createdComponent() {\n            this.getTransitionOptions();\n            this.getLastChange();\n        },\n\n        onShowStatusHistory() {\n            this.$emit('show-status-history');\n        },\n\n        getTransitionOptions() {\n            this.statesLoading = true;\n\n            return Promise.all([\n                this.stateMachineStateRepository.search(this.stateMachineStateCriteria),\n                this.stateMachineService.getState(this.entityName, this.entity.id),\n            ]).then((data) => {\n                this.stateOptions = this.buildTransitionOptions(data[0], data[1].data.transitions);\n\n                this.statesLoading = false;\n                return Promise.resolve();\n            });\n        },\n\n        buildTransitionOptions(allTransitions, possibleTransitions) {\n            const options = allTransitions.map((state, index) => {\n                return {\n                    stateName: state.technicalName,\n                    id: index,\n                    name: state.translated.name,\n                    disabled: true,\n                };\n            });\n\n            options.forEach((option) => {\n                const transitionToState = possibleTransitions.filter((transition) => {\n                    return transition.toStateName === option.stateName;\n                });\n\n                if (transitionToState.length >= 1) {\n                    option.disabled = false;\n                    option.id = transitionToState[0].actionName;\n                }\n            });\n\n            return options;\n        },\n\n        onStateSelected(stateType, actionName) {\n            if (!stateType || !actionName) {\n                this.createStateChangeErrorNotification(this.$tc('sw-order.stateCard.labelErrorNoAction'));\n                return;\n            }\n\n            if (!this.modalConfirmed) {\n                this.currentActionName = actionName;\n                this.showStateChangeModal = true;\n\n                return;\n            }\n\n            this.stateChangeModalConfirmed = false;\n        },\n\n        onLeaveModalClose() {\n            this.stateChangeModalConfirmed = false;\n            this.currentActionName = null;\n            this.showStateChangeModal = false;\n        },\n\n        onLeaveModalConfirm() {\n            this.showStateChangeModal = false;\n\n            this.stateTransitionMethod(this.entity.id, this.currentActionName)\n                .then(() => {\n                    this.getLastChange();\n\n                    return this.getTransitionOptions();\n                })\n                .then(() => {\n                    this.$emit('save-edits');\n                })\n                .catch((error) => {\n                    this.createStateChangeErrorNotification(error);\n                })\n                .finally(() => {\n                    this.stateChangeModalConfirmed = false;\n                    this.currentActionName = null;\n                });\n        },\n\n        createStateChangeErrorNotification(errorMessage) {\n            this.createNotificationError({\n                message: this.$tc('sw-order.stateCard.labelErrorStateChange') + errorMessage,\n            });\n        },\n\n        getLastChange() {\n            this.lastStateChange = null;\n            this.stateMachineHistoryRepository.search(this.stateMachineHistoryCriteria).then((result) => {\n                this.lastStateChange = result.first();\n            });\n        },\n    },\n};\n"],"names":["template","Criteria","index","criteria","technicalName","data","allTransitions","possibleTransitions","options","state","option","transitionToState","transition","stateType","actionName","error","errorMessage","result"],"mappings":"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"}