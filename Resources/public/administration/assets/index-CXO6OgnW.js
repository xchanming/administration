import{ae as q,a7 as g,af as h,ag as S,T as k,L as y,U as F,ab as x,H as b,a as A,X as B,K as $,Q as N}from"./channel-oRk5-XZJ.js";import{_ as E}from"./_baseIteratee-CqDR5IDS.js";import"./administration-DCOj2uiN.js";var C=q,G=g;function T(e,t){return e&&C(e,t,G)}var M=T,O=h;function D(e,t){return function(i,o){if(i==null)return i;if(!O(i))return e(i,o);for(var s=i.length,n=t?s:-1,c=Object(i);(t?n--:++n<s)&&o(c[n],n,c)!==!1;);return i}}var L=D,j=M,U=L,P=U(j),R=P,z=R,V=h;function K(e,t){var i=-1,o=V(e)?Array(e.length):[];return z(e,function(s,n,c){o[++i]=t(s,n,c)}),o}var W=K;function I(e,t){var i=e.length;for(e.sort(t);i--;)e[i]=e[i].value;return e}var H=I,w=S;function Q(e,t){if(e!==t){var i=e!==void 0,o=e===null,s=e===e,n=w(e),c=t!==void 0,l=t===null,a=t===t,r=w(t);if(!l&&!r&&!n&&e>t||n&&c&&a&&!l&&!r||o&&c&&a||!i&&a||!s)return 1;if(!o&&!n&&!r&&e<t||r&&i&&s&&!o&&!n||l&&i&&s||!c&&s||!a)return-1}return 0}var X=Q,J=X;function Y(e,t,i){for(var o=-1,s=e.criteria,n=t.criteria,c=s.length,l=i.length;++o<c;){var a=J(s[o],n[o]);if(a){if(o>=l)return a;var r=i[o];return a*(r=="desc"?-1:1)}}return e.index-t.index}var Z=Y,d=k,ee=y,te=E,ie=W,ne=H,oe=F,se=Z,ce=x,ae=b;function le(e,t,i){t.length?t=d(t,function(n){return ae(n)?function(c){return ee(c,n.length===1?n[0]:n)}:n}):t=[ce];var o=-1;t=d(t,oe(te));var s=ie(e,function(n,c,l){var a=d(t,function(r){return r(n)});return{criteria:a,index:++o,value:n}});return ne(s,function(n,c){return se(n,c,i)})}var v=le,re=v,m=b;function ue(e,t,i,o){return e==null?[]:(m(t)||(t=t==null?[]:[t]),i=o?void 0:i,m(i)||(i=i==null?[]:[i]),re(e,t,i))}var de=ue;const pe=A(de);var we=$,me=v,_e=B,_=N,fe=_e(function(e,t){if(e==null)return[];var i=t.length;return i>1&&_(e,t[0],t[1])?t=[]:i>2&&_(t[0],t[1],t[2])&&(t=[t[0]]),me(e,we(t,1),[])}),he=fe;const f=A(he),be=`{% block sw_flow_sequence_action %} <div class="sw-flow-sequence-action" :class="actionClasses" > {% block sw_flow_sequence_action_card %} <div class="sw-flow-sequence-action__card"> {% block sw_flow_sequence_action_header %} <div class="sw-flow-sequence-action__header"> {% block sw_flow_sequence_action_title %} <div class="sw-flow-sequence-action__title-description"> <h3 class="sw-flow-sequence-action__title"> {{ $tc('sw-flow.detail.sequence.actionTitle') }} </h3> <p class="sw-flow-sequence-action__description"> {{ $tc('sw-flow.detail.sequence.actionDescription') }} </p> </div> {% endblock %} {% block sw_flow_sequence_action_context_menu %} <sw-context-button class="sw-flow-sequence-action__context-button" :class="actionClasses" :disabled="disabled" > {% block sw_flow_sequence_action_remove_action_container %} <sw-context-menu-item variant="danger" class="sw-flow-sequence-action__delete-action-container" @click="removeActionContainer" > {{ $tc('sw-flow.detail.sequence.contextButton.deleteActionContainer') }} </sw-context-menu-item> {% endblock %} </sw-context-button> {% endblock %} </div> {% endblock %} {% block sw_flow_sequence_action_content %} <div class="sw-flow-sequence-action__content"> {% block sw_flow_sequence_action_actions %} <div class="sw-flow-sequence-action__actions"> {% block sw_flow_sequence_action_actions_empty %} <div v-if="sequenceData.length === 1 && !sequence.actionName" class="sw-flow-sequence-action__actions-empty" > <sw-icon size="12px" name="regular-minus-xs" /> <span class="sw-flow-sequence-action__no-action"> {{ $tc('sw-flow.detail.sequence.noActions') }} </span> </div> {% endblock %} {% block sw_flow_sequence_action_actions_list %} <ul v-else class="sw-flow-sequence-action__action-list" > {% block sw_flow_sequence_action_actions_transition_group %} <transition-group name="list" tag="div" > {% block sw_flow_sequence_action_actions_item %} <li v-for="(item, key) in sequenceData" :key="item.id" v-tooltip="{ message: $tc('sw-flow.actions.tooltipActionDisabled'), disabled: !item.disabled }" class="sw-flow-sequence-action__action-item" :class="{'sw-flow-sequence-action__disabled': item.disabled}" role="button" tabindex="0" @click="(event) => onEditAction(item, event.target, key)" @keydown.enter="(event) => onEditAction(item, event.target, key)" > <sw-flow-sequence-action-error v-if="!isValidAction(item.actionName)" :sequence="item" > <template #content> <div class="sw-flow-sequence-action__error-action"> <div class="sw-flow-sequence-action__error-action-title"> <sw-icon name="regular-question-circle-s" size="14px" class="sw-icon-action" /> {{ $tc('sw-flow.actions.unknownLabel') }} </div> <p> {{ $tc('sw-flow.actions.warningText') }} </p> </div> </template> </sw-flow-sequence-action-error> <div v-else> {% block sw_flow_sequence_action_actions_item_header %} <div class="sw-flow-sequence-action__action-header"> <div class="sw-flow-sequence-action__action-icon"> <sw-icon v-if="!item.iconRaw" :name="\`\${item.icon}\`" size="12px" class="sw-icon-action" /> <img v-else class="sw-flow-sequence-action__icon-raw sw-icon" :src="\`data:image/png;base64, \${item.iconRaw}\`" alt="" > </div> {% block sw_flow_sequence_action_actions_item_name %} <div class="sw-flow-sequence-action__action-name"> <h3>{{ item.label }}</h3> </div> {% endblock %} {% block sw_flow_sequence_action_actions_item_context_button %} <sw-context-button ref="contextButton" class="sw-flow-sequence-action__context-button" :disabled="disabled || item.disabled" > {% block sw_flow_sequence_action_actions_item_button_edit %} <sw-context-menu-item v-if="isNotStopFlow(item)" class="sw-flow-sequence-action__edit-action" @click="(event) => onEditAction(item, event.target, key)" > {{ $tc('sw-flow.actions.contextButton.editAction') }} </sw-context-menu-item> {% endblock %} {% block sw_flow_sequence_action_actions_item_button_delete %} <sw-context-menu-item variant="danger" class="sw-flow-sequence-action__delete-action" @click="removeAction(item.id)" > {{ $tc('sw-flow.actions.contextButton.deleteAction') }} </sw-context-menu-item> {% endblock %} {% block sw_flow_sequence_action_actions_item_button_move_up %} <sw-context-menu-item v-if="showMoveOption(item, 'up')" class="sw-flow-sequence-action__move-up" @click="moveAction(item, 'up', key)" > {{ $tc('sw-flow.actions.contextButton.moveUpAction') }} </sw-context-menu-item> {% endblock %} {% block sw_flow_sequence_action_actions_item_button_move_down %} <sw-context-menu-item v-if="showMoveOption(item, 'down')" class="sw-flow-sequence-action__move-down" @click="moveAction(item, 'down', key)" > {{ $tc('sw-flow.actions.contextButton.moveDownAction') }} </sw-context-menu-item> {% endblock %} </sw-context-button> {% endblock %} </div> {% endblock %} </div> {% block sw_flow_sequence_action_actions_item_description %} <div class="sw-flow-sequence-action__action-description" v-html="getActionDescriptions(item)" > </div> {% endblock %} {% block sw_flow_sequence_action_item_custom %} {% endblock %} </li> {% endblock %} </transition-group> {% endblock %} </ul> {% endblock %} </div> {% endblock %} {% block sw_flow_sequence_action_add_select %} <div v-if="showAddAction && !disabled" class="sw-flow-sequence-action__select" > {% block sw_flow_sequence_action_list %} <sw-grouped-single-select class="sw-flow-sequence-action__selection-action" size="small" value="" :placeholder="$tc('sw-flow.actions.placeholderSelectAction')" :options="actionOptions" :groups="groups" :popover-classes="['sw-flow-sequence-action__popover']" :error="fieldError" :disabled="isUnknownTrigger" @update:value="openDynamicModal" > <template #result-item="{ item, index, labelProperty, highlightSearchTerm, isSelected, setValue, getKey }"> <sw-select-result v-tooltip="{ message: $tc('sw-flow.actions.tooltipActionDisabled'), disabled: !item.disabled }" :selected="isSelected(item)" v-bind="{ item, index }" :class="[stopFlowStyle(item.value), {'sw-flow-sequence-action__disabled': item.disabled}]" @item-select="setValue" > {% block sw_flow_sequence_action_select_results_list_result_label %} <sw-icon v-if="!item.iconRaw" :name="\`\${item.icon}\`" size="12px" class="sw-icon-action" /> <img v-else class="sw-flow-sequence-action__icon-raw" :src="\`data:image/png;base64, \${item.iconRaw}\`" alt="" > <sw-highlight-text v-if="highlightSearchTerm" :text="getKey(item, labelProperty)" /> <template v-else> {{ getKey(item, labelProperty) }} </template> {% endblock %} </sw-select-result> </template> </sw-grouped-single-select> {% endblock %} </div> {% endblock %} </div> {% endblock %} </div> {% endblock %} <div v-if="errorArrow" class="sw-flow-sequence-action__true-arrow" > <div class="sw-flow-sequence-action__true-line"></div> <div class="sw-flow-sequence-action__oval"></div> <sw-icon name="regular-chevron-right-s" small /> </div> {% block sw_flow_sequence_action_modal %} <sw-flow-sequence-modal :sequence="currentSequence" :action="selectedAction" :modal-name="modalName" @process-finish="onSaveActionSuccess" @modal-close="onCloseModal" /> {% endblock %} </div> {% endblock %}`,{Component:Ae,State:u,Mixin:ve}=Cicada,p=Cicada.Utils,{cloneDeep:qe}=p.object,{CicadaError:ge}=Cicada.Classes,{mapState:Se,mapGetters:ke}=Ae.getComponentHelper(),{snakeCase:ye}=p.string,$e={template:be,compatConfig:Cicada.compatConfig,inject:["repositoryFactory","flowBuilderService","feature"],mixins:[ve.getByName("sw-inline-snippet")],props:{sequence:{type:Object,required:!0},disabled:{type:Boolean,required:!1,default:!1},isUnknownTrigger:{type:Boolean,required:!1,default:!1}},data(){return{fieldError:null,selectedAction:"",currentSequence:{},appFlowActions:[],isAppAction:!1}},computed:{sequenceRepository(){return this.repositoryFactory.create("flow_sequence")},customFieldSetRepository(){return this.repositoryFactory.create("custom_field_set")},actionOptions(){const e=this.availableActions.map(t=>this.getActionTitle(t));return this.sortActionOptions(e)},groups(){var t,i,o,s;const e=this.actionGroups.map(n=>({id:n,label:this.$tc(`sw-flow.actions.group.${n}`)}));if((t=this.appActions)!=null&&t.length){const n=this.appActions[0];this.actionGroups.find(l=>{var a;return l===((a=n==null?void 0:n.app)==null?void 0:a.name)})||e.unshift({id:`${(i=n==null?void 0:n.app)==null?void 0:i.name[0].toLowerCase()}${(o=n==null?void 0:n.app)==null?void 0:o.name.slice(1)}`,label:(s=n==null?void 0:n.app)==null?void 0:s.label})}return f(e,["label"])},sequenceData(){return this.sequence.id?[{...this.sequence,...this.getActionTitle(this.sequence.actionName)}]:this.sortByPosition(Object.values(this.sequence).map(e=>({...e,...this.getActionTitle(e.actionName)})))},showAddAction(){return!(this.sequence.actionName===this.stopFlowActionName||this.sequenceData.some(e=>e.actionName===this.stopFlowActionName))},stopFlowActionName(){return this.flowBuilderService.getActionName("STOP_FLOW")},actionClasses(){return{"is--stop-flow":!this.showAddAction,"has--arrow":this.errorArrow}},errorArrow(){return!this.isValidAction(this.sequence)&&this.sequence.actionName&&this.sequence.trueBlock},modalName(){return this.getSelectedAppAction(this.selectedAction)?"sw-flow-app-action-modal":this.flowBuilderService.getActionModalName(this.selectedAction)},currentLocale(){return Cicada.State.get("session").currentLocale},...Se("swFlowState",["invalidSequences","stateMachineState","documentTypes","mailTemplates","customerGroups","customFieldSets","customFields","triggerEvent","triggerActions"]),...ke("swFlowState",["availableActions","actionGroups","sequences","appActions","getSelectedAppAction"])},watch:{sequence:{handler(){this.setFieldError()}}},methods:{openDynamicModal(e){const t=this.getSelectedAppAction(e);if(t&&(this.isAppAction=!0,this.currentSequence.propsAppFlowAction=t),e===this.stopFlowActionName){this.addAction({name:this.stopFlowActionName,config:null});return}this.selectedAction=e},onSaveActionSuccess(e){const{config:t,id:i}=e;let o=t==null?void 0:t.entity,s=this.selectedAction;const n=this.flowBuilderService.mapActionType(this.selectedAction);n&&o&&(o=ye(o).replace("_","."),s=n.replace("entity",o)),i?this.editAction({name:s,config:t}):this.addAction({name:s,config:t}),this.onCloseModal()},onCloseModal(){this.currentSequence={},this.selectedAction="",this.isAppAction=!1,this.isCompatEnabled("INSTANCE_DELETE")?this.$delete(this.sequence,"propsAppFlowAction"):delete this.sequence.propsAppFlowAction},addAction(e){if(!e.name)return;const t=this.getSelectedAppAction(e.name);if(!this.sequence.actionName&&this.sequence.id){const i={id:this.sequence.id,actionName:e.name,config:e.config};t&&(i.appFlowActionId=t.id),u.commit("swFlowState/updateSequence",i)}else{const i=this.sequenceData[this.sequenceData.length-1];let o=this.sequenceRepository.create();const s={...o,parentId:i.parentId,trueCase:i.trueCase,displayGroup:i.displayGroup,ruleId:null,actionName:e.name,position:i.position+1,config:e.config,id:p.createId()};t&&(s.appFlowActionId=t.id),o=Object.assign(o,s),u.commit("swFlowState/addSequence",o)}this.removeFieldError()},editAction(e){e.name&&u.commit("swFlowState/updateSequence",{id:this.currentSequence.id,actionName:e.name,config:e.config})},removeAction(e){var i;const t=this.sequences.find(o=>o.id===e);t!=null&&t.id&&this.sequences.filter(s=>s.parentId===t.parentId&&s.trueCase===t.trueCase&&s.id!==e).forEach((s,n)=>{u.commit("swFlowState/updateSequence",{id:s.id,position:n+1})}),!this.isAppDisabled(this.getSelectedAppAction((i=this.sequence[e])==null?void 0:i.actionName))&&u.commit("swFlowState/removeSequences",[e])},actionsWithoutStopFlow(){if(this.sequence.id)return[{...this.sequence}];const e=Object.values(this.sequence);return this.sortByPosition(e.filter(t=>t.actionName!==this.stopFlowActionName))},showMoveOption(e,t){const i=this.actionsWithoutStopFlow();return i.length<=1||t==="up"&&i[0].position===e.position||t==="down"&&i[i.length-1].position===e.position?!1:e.actionName!==this.stopFlowActionName},moveAction(e,t,i){if(this.isAppDisabled(this.getSelectedAppAction(e.actionName)))return;const o=this.actionsWithoutStopFlow(),s=o.findIndex(r=>r.position===e.position),n=t==="up"?o[s-1]:o[s+1],c=qe(n);u.commit("swFlowState/updateSequence",{id:n.id,position:e.position}),u.commit("swFlowState/updateSequence",{id:e.id,position:c.position});const l=t==="up"?i-1:i+1,a=this.$refs.contextButton;[a[i],a[l]]=[a[l],a[i]]},onEditAction(e,t,i){e.actionName&&e.actionName===this.stopFlowActionName||this.hasAvailableAction(e.actionName)&&(!(e!=null&&e.actionName)||!t||this.$refs.contextButton[i]&&this.$refs.contextButton[i].$el.contains(t)||this.isAppDisabled(this.getSelectedAppAction(e.actionName))||(e.propsAppFlowAction=this.getSelectedAppAction(e.actionName),this.currentSequence=e,this.selectedAction=e.actionName))},removeActionContainer(){const e=this.sequence.id?[this.sequence.id]:Object.keys(this.sequence);u.commit("swFlowState/removeSequences",e)},getActionTitle(e){var o,s,n,c;if(!e)return null;const t=this.getSelectedAppAction(e);if(t)return{label:t.label||((o=t.translated)==null?void 0:o.label),icon:t.swIcon,iconRaw:t.icon,value:t.name,disabled:!((s=t.app)!=null&&s.active),group:`${(n=t.app)==null?void 0:n.name[0].toLowerCase()}${(c=t.app)==null?void 0:c.name.slice(1)}`};const i=this.flowBuilderService.getActionTitle(e);return{...i,label:this.$tc(i.label),group:this.flowBuilderService.getActionGroupMapping(e)}},sortByPosition(e){return e.sort((t,i)=>t.position-i.position)},stopFlowStyle(e){return{"is--stop-flow":e===this.stopFlowActionName}},getActionDescriptions(e){if(!e.actionName)return"";const t={appActions:this.appActions,customerGroups:this.customerGroups,customFieldSets:this.customFieldSets,customFields:this.customFields,stateMachineState:this.stateMachineState,documentTypes:this.documentTypes,mailTemplates:this.mailTemplates};return this.flowBuilderService.getActionDescriptions(t,e,this)},setFieldError(){var e;if(!((e=this.invalidSequences)!=null&&e.includes(this.sequence.id))){this.fieldError=null;return}this.fieldError=new ge({code:"c1051bb4-d103-4f74-8988-acbcafc7fdc3"})},removeFieldError(){var t;if(!this.fieldError)return;this.fieldError=null;const e=(t=this.invalidSequences)==null?void 0:t.filter(i=>this.sequence.id!==i);u.commit("swFlowState/setInvalidSequences",e)},isNotStopFlow(e){return e.actionName!==this.stopFlowActionName},capitalize(e){return`${e.slice(0,1).toUpperCase()}${e.slice(1)}`},isAppDisabled(e){return e?!e.app.active:!1},getStopFlowIndex(e){return e.map((i,o)=>i.group===this.flowBuilderService.getGroup("GENERAL")?o:!1).filter(i=>i>0).pop()||e.length},sortActionOptions(e){const t=e.pop();e=pe(e,["group","label"]),e.forEach(o=>{o.group&&o.group!==this.flowBuilderService.getGroup("GENERAL")||(o.group=o.group||this.flowBuilderService.getGroup("GENERAL"),e.push(e.splice(e.findIndex(s=>s.group===this.flowBuilderService.getGroup("GENERAL")),1)[0]))}),e=f(e,["group","label"],["esc","esc"]);const i=this.getStopFlowIndex(e)+1;return e.splice(i,0,t),e},hasAvailableAction(e){return this.availableActions.includes(e)},isValidAction(e){return e&&this.hasAvailableAction(e)}}};export{$e as default};
//# sourceMappingURL=index-CXO6OgnW.js.map
