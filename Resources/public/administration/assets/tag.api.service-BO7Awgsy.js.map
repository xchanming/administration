{"version":3,"file":"tag.api.service-BO7Awgsy.js","sources":["../../../app/administration/src/core/service/api/tag.api.service.js"],"sourcesContent":["/**\n * @package inventory\n */\nimport ApiService from '../api.service';\n\nconst { Service } = Cicada;\nconst { Criteria } = Cicada.Data;\n\n// eslint-disable-next-line sw-deprecation-rules/private-feature-declarations\nexport default class TagApiService extends ApiService {\n    constructor(httpClient, loginService) {\n        super(httpClient, loginService, null, 'application/json');\n        this.name = 'tagApiService';\n    }\n\n    /**\n     * @param params: RequestParams\n     * @param filters: Object\n     * @param additionalHeaders: Object\n     * @returns {*} - ApiService.handleResponse(response)\n     */\n    filterIds(params, filters = {}, additionalHeaders = {}) {\n        return this.httpClient\n            .post(\n                '_admin/tag-filter-ids',\n                { ...params, ...filters },\n                {\n                    headers: this.getBasicHeaders(additionalHeaders),\n                },\n            )\n            .then((response) => ApiService.handleResponse(response));\n    }\n\n    /**\n     * @param ids: Array\n     * @param name: String\n     * @param definitionProperties: Object\n     * @param bulkMergeProgress: Object\n     */\n    async merge(ids, name, definitionProperties, bulkMergeProgress) {\n        const limit = 200;\n        const tagRepository = this.getRepository('tag');\n\n        bulkMergeProgress.isRunning = true;\n\n        const tag = tagRepository.create();\n        tag.name = name;\n\n        await tagRepository.save(tag);\n        tag._isNew = false;\n\n        // eslint-disable-next-line\n        for (const [\n            propertyName,\n            property,\n        ] of Object.entries(definitionProperties)) {\n            if (property.relation !== 'many_to_many') {\n                // eslint-disable-next-line\n                continue;\n            }\n\n            let page = 1;\n            bulkMergeProgress.currentAssignment = propertyName;\n            bulkMergeProgress.progress = 0;\n            bulkMergeProgress.total = 0;\n\n            const repository = this.getRepository(property.entity);\n\n            do {\n                const criteria = new Criteria(page, limit);\n                criteria.addFilter(Criteria.equalsAny('tags.id', ids));\n\n                // eslint-disable-next-line\n                const { data, total } = await repository.searchIds(criteria, Cicada.Context.api);\n                tag[propertyName] = data.map((id) => {\n                    return { id };\n                });\n\n                if (total !== 0) {\n                    bulkMergeProgress.total = total;\n                    // eslint-disable-next-line\n                    await tagRepository.save(tag);\n                }\n                tag[propertyName] = [];\n\n                bulkMergeProgress.progress += data.length;\n                page += 1;\n            } while (bulkMergeProgress.isRunning && bulkMergeProgress.progress < bulkMergeProgress.total);\n        }\n\n        if (!bulkMergeProgress.isRunning) {\n            return;\n        }\n\n        await tagRepository.syncDeleted(ids, Cicada.Context.api);\n    }\n\n    getRepository(entity) {\n        return Service('repositoryFactory').create(entity);\n    }\n}\n"],"names":["Service","Criteria","TagApiService","ApiService","httpClient","loginService","params","filters","additionalHeaders","response","ids","name","definitionProperties","bulkMergeProgress","tagRepository","tag","propertyName","property","page","repository","criteria","data","total","id","entity"],"mappings":"iHAKA,KAAM,CAAE,QAAAA,CAAS,EAAG,OACd,CAAE,SAAAC,CAAQ,EAAK,OAAO,KAGb,MAAMC,UAAsBC,CAAW,CAClD,YAAYC,EAAYC,EAAc,CAClC,MAAMD,EAAYC,EAAc,KAAM,kBAAkB,EACxD,KAAK,KAAO,eACf,CAQD,UAAUC,EAAQC,EAAU,CAAA,EAAIC,EAAoB,CAAA,EAAI,CACpD,OAAO,KAAK,WACP,KACG,wBACA,CAAE,GAAGF,EAAQ,GAAGC,CAAS,EACzB,CACI,QAAS,KAAK,gBAAgBC,CAAiB,CAClD,CACJ,EACA,KAAMC,GAAaN,EAAW,eAAeM,CAAQ,CAAC,CAC9D,CAQD,MAAM,MAAMC,EAAKC,EAAMC,EAAsBC,EAAmB,CAE5D,MAAMC,EAAgB,KAAK,cAAc,KAAK,EAE9CD,EAAkB,UAAY,GAE9B,MAAME,EAAMD,EAAc,SAC1BC,EAAI,KAAOJ,EAEX,MAAMG,EAAc,KAAKC,CAAG,EAC5BA,EAAI,OAAS,GAGb,SAAW,CACPC,EACAC,CACZ,IAAa,OAAO,QAAQL,CAAoB,EAAG,CACvC,GAAIK,EAAS,WAAa,eAEtB,SAGJ,IAAIC,EAAO,EACXL,EAAkB,kBAAoBG,EACtCH,EAAkB,SAAW,EAC7BA,EAAkB,MAAQ,EAE1B,MAAMM,EAAa,KAAK,cAAcF,EAAS,MAAM,EAErD,EAAG,CACC,MAAMG,EAAW,IAAInB,EAASiB,EAAM,GAAK,EACzCE,EAAS,UAAUnB,EAAS,UAAU,UAAWS,CAAG,CAAC,EAGrD,KAAM,CAAE,KAAAW,EAAM,MAAAC,CAAO,EAAG,MAAMH,EAAW,UAAUC,EAAU,OAAO,QAAQ,GAAG,EAC/EL,EAAIC,CAAY,EAAIK,EAAK,IAAKE,IACnB,CAAE,GAAAA,CAAE,EACd,EAEGD,IAAU,IACVT,EAAkB,MAAQS,EAE1B,MAAMR,EAAc,KAAKC,CAAG,GAEhCA,EAAIC,CAAY,EAAI,GAEpBH,EAAkB,UAAYQ,EAAK,OACnCH,GAAQ,CACxB,OAAqBL,EAAkB,WAAaA,EAAkB,SAAWA,EAAkB,MAC1F,CAEIA,EAAkB,WAIvB,MAAMC,EAAc,YAAYJ,EAAK,OAAO,QAAQ,GAAG,CAC1D,CAED,cAAcc,EAAQ,CAClB,OAAOxB,EAAQ,mBAAmB,EAAE,OAAOwB,CAAM,CACpD,CACL"}