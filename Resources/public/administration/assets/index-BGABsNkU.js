const _=`{% block sw_order_state_history_modal %} <sw-modal :title="$tc('sw-order.stateHistoryModal.modalTitle')" :is-loading="isLoading" variant="large" @modal-close="onClose" > {% block sw_order_state_history_modal_content %} <sw-data-grid :columns="columns" :data-source="dataSource" :is-loading="isLoading || statesLoading" :plain-appearance="true" :show-selection="false" :show-actions="false" > {% block sw_order_state_history_modal_content_columns_created_at %} <template #column-createdAt="{ item }"> <sw-time-ago :date="item.createdAt" /> </template> {% endblock %} {% block sw_order_state_history_modal_content_columns_entity %} <template #column-entity="{ item }"> {{ $tc('global.entities.' + item.entity) }} {{ enumerateTransaction(item) }} </template> {% endblock %} {% block sw_order_state_history_modal_content_columns_user %} <template #column-user="{ item }"> {{ item.user?.username ?? $tc('sw-order.stateHistoryModal.labelSystemUser') }} </template> {% endblock %} {% block sw_order_state_history_modal_content_columns_order_state %} <template #column-order="{ item }"> <sw-label :variant="getVariantState('order', item.order)" appearance="badged" > {{ item.order.translated.name }} </sw-label> </template> {% endblock %} {% block sw_order_state_history_modal_content_columns_delivery_state %} <template #column-delivery="{ item }"> <sw-label v-if="item.delivery" :variant="getVariantState('order_delivery', item.delivery)" appearance="badged" > {{ item.delivery.translated.name }} </sw-label> </template> {% endblock %} {% block sw_order_state_history_modal_content_columns_transaction_state %} <template #column-transaction="{ item }"> <sw-label :variant="getVariantState('order_transaction', item.transaction)" appearance="badged" > {{ item.transaction.translated.name }} </sw-label> </template> {% endblock %} <template #pagination> <sw-pagination :page="page" :limit="limit" :total="total" :steps="steps" @page-change="onPageChange" /> </template> </sw-data-grid> {% endblock %} {% block sw_order_state_history_modal_actions %} <template #modal-footer> {% block sw_order_state_history_modal_action_close %} <sw-button size="small" @click="onClose" > {{ $tc('global.default.close') }} </sw-button> {% endblock %} </template> {% endblock %} </sw-modal> {% endblock %}`,{Component:u,Mixin:p}=Shopware,{Criteria:n}=Shopware.Data,y=u.wrapComponentConfig({template:_,inject:["repositoryFactory","stateStyleDataProviderService"],mixins:[p.getByName("notification")],props:{order:{type:Object,required:!0},isLoading:{type:Boolean,required:!0}},data(){return{dataSource:[],statesLoading:!0,limit:10,page:1,total:0,steps:[5,10,25]}},computed:{stateMachineHistoryRepository(){return this.repositoryFactory.create("state_machine_history")},stateMachineHistoryCriteria(){const t=new n(this.page,this.limit),e=[this.order.id,...(this.order.transactions??[]).map(a=>a.id),...(this.order.deliveries??[]).map(a=>a.id)];return t.addFilter(n.equalsAny("state_machine_history.referencedId",e)),t.addFilter(n.equalsAny("state_machine_history.entityName",["order","order_transaction","order_delivery"])),t.addAssociation("fromStateMachineState"),t.addAssociation("toStateMachineState"),t.addAssociation("user"),t.addSorting({field:"state_machine_history.createdAt",order:"ASC",naturalSorting:!1}),t},columns(){return[{property:"createdAt",label:this.$tc("sw-order.stateHistoryModal.column.createdAt")},{property:"entity",label:this.$tc("sw-order.stateHistoryModal.column.entity")},{property:"user",label:this.$tc("sw-order.stateHistoryModal.column.user")},{property:"transaction",label:this.$tc("sw-order.stateHistoryModal.column.transaction")},{property:"delivery",label:this.$tc("sw-order.stateHistoryModal.column.delivery")},{property:"order",label:this.$tc("sw-order.stateHistoryModal.column.order")}]},hasMultipleTransactions(){var t,e,a;return(((a=(e=(t=this.order)==null?void 0:t.transactions)==null?void 0:e.filter((o,i,s)=>s.indexOf(o)===i))==null?void 0:a.length)??0)>1}},created(){this.createdComponent()},methods:{createdComponent(){this.loadHistory()},async loadHistory(){var t,e,a,o;this.statesLoading=!0;try{await this.getStateHistoryEntries()}catch(i){const s=((o=(a=(e=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:e.errors)==null?void 0:a[0])==null?void 0:o.detail)||"";this.createNotificationError({message:s})}finally{this.statesLoading=!1}},getStateHistoryEntries(){return this.stateMachineHistoryRepository.search(this.stateMachineHistoryCriteria).then(t=>(this.dataSource=this.buildStateHistory(t),this.total=t.total??1,Promise.resolve(t)))},buildStateHistory(t){var i,s,d,l,c,m,h;const e={order:((i=t.filter(r=>r.entityName==="order")[0])==null?void 0:i.fromStateMachineState)??this.order.stateMachineState,order_transaction:((s=t.filter(r=>r.entityName==="order_transaction")[0])==null?void 0:s.fromStateMachineState)??((l=(d=this.order.transactions)==null?void 0:d.last())==null?void 0:l.stateMachineState),order_delivery:((c=t.filter(r=>r.entityName==="order_delivery")[0])==null?void 0:c.fromStateMachineState)??((h=(m=this.order.deliveries)==null?void 0:m.first())==null?void 0:h.stateMachineState)},a=[];this.page===1&&a.push(this.createEntry(e,this.order));const o=[];return t.forEach(r=>{r.entityName==="order_transaction"&&!o.includes(r.referencedId)&&(o.length>0&&a.push(this.createEntry({...e,order_transaction:r.fromStateMachineState},{...r,user:void 0})),o.push(r.referencedId)),e[r.entityName]=r.toStateMachineState,a.push(this.createEntry(e,r))}),a},createEntry(t,e){return{order:t.order,transaction:t.order_transaction,delivery:t.order_delivery,createdAt:"orderDateTime"in e?e.orderDateTime:e.createdAt,user:"user"in e?e.user:void 0,entity:"entityName"in e?e.entityName:"order",referencedId:"referencedId"in e?e.referencedId:void 0}},getVariantState(t,e){return this.stateStyleDataProviderService.getStyle(`${t}.state`,e.technicalName).variant},onClose(){this.$emit("modal-close")},onPageChange({page:t,limit:e}){this.page=t,this.limit=e,this.loadHistory()},enumerateTransaction(t){var a;if(t.entity!=="order_transaction"||!this.hasMultipleTransactions)return"";const e=((a=this.order.transactions)==null?void 0:a.findIndex(o=>o.id===t.referencedId))??-1;return String(e>=0?e+1:"")}}});export{y as default};
