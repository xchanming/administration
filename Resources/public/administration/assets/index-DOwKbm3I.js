const{Criteria:d}=Cicada.Data,y={namespaced:!0,state(){return{landingPage:null,category:null,customFieldSets:[],landingPagesToDelete:void 0,categoriesToDelete:void 0}},mutations:{setActiveLandingPage(e,{landingPage:t}){e.landingPage=t},setActiveCategory(e,{category:t}){e.category=t},setCustomFieldSets(e,t){e.customFieldSets=t},setLandingPagesToDelete(e,{landingPagesToDelete:t}){e.landingPagesToDelete=t},setCategoriesToDelete(e,{categoriesToDelete:t}){e.categoriesToDelete=t}},actions:{setActiveLandingPage({commit:e},t){e("setActiveLandingPage",t)},loadActiveLandingPage({commit:e},{repository:t,id:s,apiContext:n,criteria:a}){if(s==="create"){const i=t.create(n);return i.cmsPageId=null,e("setActiveLandingPage",{landingPage:i}),Promise.resolve()}return a||(a=new d(1,25)),t.get(s,n,a).then(i=>{e("setActiveLandingPage",{landingPage:i})})},setActiveCategory({commit:e},t){e("setActiveCategory",t)},loadActiveCategory({commit:e},{repository:t,id:s,apiContext:n,criteria:a}){return a||(a=new d(1,25)),t.get(s,n,a).then(i=>{if(i.isColumn=!1,i.parentId!==null){const r=new d(1,25);return r.addAssociation("footerSalesChannels"),t.get(i.parentId,n,r).then(l=>(i.parent=l,i.isColumn=i.parent!==void 0&&i.parent.footerSalesChannels!==void 0&&i.parent.footerSalesChannels.length!==0,Promise.resolve(i)))}return Promise.resolve(i)}).then(i=>{e("setActiveCategory",{category:i})})}}},m=`{% block sw_category %} <sw-page class="sw-category" :class="pageClasses" > <template #search-bar> {% block sw_category_search_bar %} <sw-search-bar ref="searchBar" initial-search-type="category" :initial-search="term" type-search-always-in-container @search="onSearch" /> {% endblock %} </template> <template #smart-bar-header> {% block sw_category_smart_bar_header %} <h2 v-if="category"> {{ placeholder(category, 'name') }} </h2> <h2 v-else> {{ $tc('sw-category.general.headlineCategories') }} </h2> {% endblock %} </template> <template #language-switch> {% block sw_category_language_switch %} <sw-language-switch :save-changes-function="saveOnLanguageChange" :abort-change-function="abortOnLanguageChange" :disabled="landingPageId === 'create'" @on-change="onChangeLanguage" /> {% endblock %} </template> <template #smart-bar-actions> <template v-if="category || landingPage"> {% block sw_category_smart_bar_abort %} <sw-button v-tooltip.bottom="tooltipCancel" :disabled="isLoading" @click="cancelEdit" > {{ $tc('global.default.cancel') }} </sw-button> {% endblock %} {% block sw_category_smart_bar_save %} {% block sw_category_smart_bar_save_category %} <sw-button-process v-if="category" v-tooltip.bottom="tooltipSave" class="sw-category-detail__save-action" :is-loading="isLoading" :process-success="isSaveSuccessful" :disabled="isLoading || !acl.can('category.editor')" variant="primary" @update:process-success="saveFinish" @click.prevent="onSave" > {{ $tc('sw-category.general.buttonSafeCategory') }} </sw-button-process> {% endblock %} {% block sw_category_smart_bar_save_landing_page %} <sw-button-process v-if="landingPage" v-tooltip.bottom="landingPageTooltipSave" class="sw-category-detail__save-landing-page-action" :is-loading="isLoading" :process-success="isSaveSuccessful" :disabled="isLoading || !acl.can('landing_page.editor')" variant="primary" @update:process-success="saveFinish" @click.prevent="onSaveLandingPage" > {{ $tc('sw-category.general.buttonSafeCategory') }} </sw-button-process> {% endblock %} {% endblock %} </template> </template> <template #side-content> {% block sw_category_side_content %} {% block sw_category_collapse %} <sw-sidebar-collapse class="sw-category-detail__category-collapse" :expand-on-loading="landingPageId === null" > <template #header> {% block sw_category_collapse_header %} <div v-if="categoryCheckedItem > 0" class="sw-category-detail__collapse-selected-count" > {{ $tc(\`sw-category.general.treeHeadSelected\`, 0, { count: categoryCheckedItem }) }}: </div> <div v-else class="sw-category-detail__collapse-headline" > {{ $tc(\`sw-category.general.treeHeadline\`) }} </div> {% endblock %} </template> <template #actions> {% block sw_category_collapse_actions %} <div v-if="categoryCheckedItem > 0"> <sw-button class="sw-tree-actions__delete_categories" variant="danger" size="small" @click="onCategoryDelete" > {{ $tc('global.default.delete') }} </sw-button> </div> {% endblock %} </template> <template #content> {% block sw_category_tree %} <sw-category-tree ref="categoryTree" :category-id="categoryId" :current-language-id="currentLanguageId" :allow-edit="acl.can('category.editor')" :allow-create="acl.can('category.creator')" :allow-delete="acl.can('category.deleter')" @unsaved-changes="openChangeModal" @category-checked-elements-count="categoryCheckedElementsCount" /> {% endblock %} </template> </sw-sidebar-collapse> {% endblock %} {% block sw_landing_page_collapse %} <sw-sidebar-collapse class="sw-category-detail__landing-page-collapse" :expand-on-loading="landingPageId !== null" > <template #header> {% block sw_landing_page_collapse_header %} <div v-if="landingPageCheckedItem > 0" class="sw-category-detail__collapse-selected-count" > {{ $tc(\`sw-landing-page.general.treeHeadSelected\`, 0, { count: landingPageCheckedItem }) }}: </div> <div v-else class="sw-category-detail__collapse-headline" > {{ $tc(\`sw-landing-page.general.treeHeadline\`) }} </div> {% endblock %} </template> <template #actions> {% block sw_landing_page_collapse_actions %} <div v-if="landingPageCheckedItem > 0"> <sw-button class="sw-tree-actions__delete_categories" variant="danger" size="small" @click="onLandingPageDelete" > {{ $tc('global.default.delete') }} </sw-button> </div> {% endblock %} </template> <template #content> {% block sw_landing_page_tree %} <sw-landing-page-tree ref="landingPageTree" :landing-page-id="landingPageId" :current-language-id="currentLanguageId" :allow-edit="acl.can('landing_page.editor')" :allow-create="acl.can('landing_page.creator')" :allow-delete="acl.can('landing_page.deleter')" @unsaved-changes="openChangeModal" @landing-page-checked-elements-count="landingPageCheckedElementsCount" /> {% endblock %} </template> </sw-sidebar-collapse> {% endblock %} {% endblock %} </template> {% block sw_category_content %} <template #content> <template v-if="isLoading"> <sw-skeleton variant="detail-bold" /> <sw-skeleton /> </template> <template v-else> {% block sw_category_content_view %} <sw-category-view v-if="category" ref="categoryView" :is-loading="isLoading" :type="category.type" /> {% endblock %} {% block sw_category_content_entry_point_overwrite_modal %} <sw-category-entry-point-overwrite-modal v-if="showEntryPointOverwriteModal" :sales-channels="entryPointOverwriteSalesChannels" @cancel="cancelEntryPointOverwrite" @confirm="confirmEntryPointOverwrite" /> {% endblock %} {% block sw_landing_page_content_view %} <sw-landing-page-view v-if="landingPage" ref="landingPageView" :is-loading="isLoading" /> {% endblock %} {% block sw_category_content_discard_changes_modal %} <sw-discard-changes-modal v-if="isDisplayingLeavePageWarning" @keep-editing="onLeaveModalClose(nextRoute)" @discard-changes="onLeaveModalConfirm(nextRoute)" /> {% endblock %} {% block sw_category_content_empty %} <sw-empty-state v-if="showEmptyState" :title="$tc('sw-category.general.emptyStateHeadline')" > <template #icon> <img :src="assetFilter('/administration/static/img/empty-states/products-empty-state.svg')" :alt="$tc('sw-category.general.emptyStateHeadline')" > </template> </sw-empty-state> {% endblock %} </template> </template> {% endblock %} </sw-page> {% endblock %}`,{Context:C,Mixin:h}=Cicada,{Criteria:o,ChangesetGenerator:f,EntityCollection:P}=Cicada.Data,{cloneDeep:g,merge:u}=Cicada.Utils.object,c=Cicada.Utils.types,v={template:m,compatConfig:Cicada.compatConfig,inject:["acl","cmsService","repositoryFactory","seoUrlService","systemConfigApiService"],mixins:[h.getByName("notification"),h.getByName("placeholder")],shortcuts:{"SYSTEMKEY+S":{active(){return this.acl.can("category.editor")},method:"onSave"},ESCAPE:"cancelEdit"},props:{categoryId:{type:String,required:!1,default:null},landingPageId:{type:String,required:!1,default:null}},data(){return{term:"",isLoading:!1,isCustomFieldLoading:!1,isSaveSuccessful:!1,isMobileViewport:null,splitBreakpoint:1024,isDisplayingLeavePageWarning:!1,nextRoute:null,currentLanguageId:Cicada.Context.api.languageId,forceDiscardChanges:!1,categoryCheckedItem:0,landingPageCheckedItem:0,entryPointOverwriteConfirmed:!1,entryPointOverwriteSalesChannels:null}},metaInfo(){return{title:this.$createTitle(this.identifier)}},computed:{changesetGenerator(){return new f},showEmptyState(){return!this.category&&!this.landingPage},identifier(){return this.category?this.placeholder(this.category,"name"):""},landingPageRepository(){return this.repositoryFactory.create("landing_page")},categoryRepository(){return this.repositoryFactory.create("category")},cmsPageRepository(){return this.repositoryFactory.create("cms_page")},landingPage(){return Cicada.State.get("swCategoryDetail")?Cicada.State.get("swCategoryDetail").landingPage:{}},category(){return Cicada.State.get("swCategoryDetail")?Cicada.State.get("swCategoryDetail").category:{}},showEntryPointOverwriteModal(){return this.entryPointOverwriteSalesChannels!==null&&this.entryPointOverwriteSalesChannels.length},cmsPage(){return Cicada.Store.get("cmsPage").currentPage},cmsPageState(){return Cicada.Store.get("cmsPage")},cmsPageId(){return this.landingPage?this.landingPage.cmsPageId:this.category?this.category.cmsPageId:null},customFieldSetRepository(){return this.repositoryFactory.create("custom_field_set")},customFieldSetCriteria(){const e=new o(1,null);return e.addFilter(o.equals("relations.entityName","category")),e},customFieldSetLandingPageCriteria(){const e=new o(1,null);return e.addFilter(o.equals("relations.entityName","landing_page")),e},mediaRepository(){return this.repositoryFactory.create("media")},pageClasses(){return{"has--category":!!this.category,"is--mobile":!!this.isMobileViewport}},tooltipSave(){return this.acl.can("category.editor")?{message:`${this.$device.getSystemKey()} + S`,appearance:"light"}:{message:this.$tc("sw-privileges.tooltip.warning"),disabled:this.acl.can("category.editor"),showOnDisabledElements:!0}},landingPageTooltipSave(){return this.acl.can("landing_page.editor")?{message:`${this.$device.getSystemKey()} + S`,appearance:"light"}:{message:this.$tc("sw-privileges.tooltip.warning"),disabled:this.acl.can("landing_page.editor"),showOnDisabledElements:!0}},tooltipCancel(){return{message:"ESC",appearance:"light"}},categoryCriteria(){const e=new o(1,1);return e.getAssociation("seoUrls").addFilter(o.equals("isCanonical",!0)),e.addAssociation("tags").addAssociation("media").addAssociation("navigationSalesChannels.homeCmsPage.previewMedia").addAssociation("serviceSalesChannels").addAssociation("footerSalesChannels").addAssociation("translations"),e},landingPageCriteria(){const e=new o(1,1);return e.addAssociation("tags"),e.addAssociation("salesChannels"),e},assetFilter(){return Cicada.Filter.getByName("asset")}},watch:{landingPageId(){this.setLandingPage()},categoryId(){this.setCategory()},cmsPageId(){this.isLoading||(this.category&&(this.cmsPageState.resetCmsPageState(),this.getAssignedCmsPage()),this.landingPage&&(this.cmsPageState.resetCmsPageState(),this.getAssignedCmsPageForLandingPage()))}},beforeCreate(){Cicada.State.registerModule("swCategoryDetail",y),Cicada.Store.get("cmsPage").resetCmsPageState()},created(){this.createdComponent()},beforeUnmount(){Cicada.State.unregisterModule("swCategoryDetail")},beforeRouteLeave(e,t,s){if(this.forceDiscardChanges){this.forceDiscardChanges=!1,s();return}if(!this.category){s();return}const{changes:n,deletionQueue:a}=this.changesetGenerator.generate(this.category);if(n===null){s();return}const i=["id","versionId"],r=Object.keys(n).filter(p=>!i.includes(p)),l=a.length>0;if(e.name==="sw.cms.create"&&r.length===1&&r[0]==="cmsPageId"&&n.cmsPageId===null&&!l){s();return}if(r.length===0&&!l){s();return}this.isDisplayingLeavePageWarning=!0,this.nextRoute=e,s(!1)},methods:{createdComponent(){if(Cicada.ExtensionAPI.publishData({id:"sw-category-detail__category",path:"category",scope:this}),Cicada.ExtensionAPI.publishData({id:"sw-category-detail__cmsPage",path:"cmsPage",scope:this}),this.isLoading=!0,this.checkViewport(),this.registerListener(),this.categoryId!==null){this.setCategory();return}this.setLandingPage()},categoryCheckedElementsCount(e){this.categoryCheckedItem=e},landingPageCheckedElementsCount(e){this.landingPageCheckedItem=e},registerListener(){this.$device.onResize({listener:this.checkViewport})},onSearch(e){e.length===0&&(e=void 0),this.term=e},checkViewport(){this.isMobileViewport=this.$device.getViewportWidth()<this.splitBreakpoint},getAssignedCmsPage(){if(this.cmsPageId===null)return Promise.resolve(null);const e=this.cmsPageId,t=new o(1,1);return t.setIds([e]),t.addAssociation("previewMedia"),t.addAssociation("sections"),t.getAssociation("sections").addSorting(o.sort("position")),t.addAssociation("sections.blocks"),t.getAssociation("sections.blocks").addSorting(o.sort("position","ASC")).addAssociation("slots"),this.cmsPageRepository.search(t).then(s=>{const n=s.get(e);return e!==this.cmsPageId?null:(this.category.slotConfig!==null&&n.sections.forEach(a=>{a.blocks.forEach(i=>{i.slots.forEach(r=>{this.category.slotConfig[r.id]&&(r.config===null&&(r.config={}),u(r.config,g(this.category.slotConfig[r.id])))})})}),this.updateCmsPageDataMapping(),this.cmsPageState.setCurrentPage(n),this.cmsPage)})},updateCmsPageDataMapping(){this.cmsPageState.setCurrentMappingEntity("category"),this.cmsPageState.setCurrentMappingTypes(this.cmsService.getEntityMappingTypes("category")),this.cmsPageState.setCurrentDemoEntity(this.category)},getAssignedCmsPageForLandingPage(){if(this.cmsPageId===null)return Promise.resolve(null);const e=this.cmsPageId,t=new o(1,1);return t.setIds([e]),t.addAssociation("previewMedia"),t.addAssociation("sections"),t.getAssociation("sections").addSorting(o.sort("position")),t.addAssociation("sections.blocks"),t.getAssociation("sections.blocks").addSorting(o.sort("position","ASC")).getAssociation("slots").addAssociation("translations"),this.cmsPageRepository.search(t).then(s=>{const n=s.get(e);return e!==this.cmsPageId?null:(this.landingPage.slotConfig!==null&&n.sections.forEach(a=>{a.blocks.forEach(i=>{i.slots.forEach(r=>{this.landingPage.slotConfig[r.id]&&(r.config===null&&(r.config={}),u(r.config,g(this.landingPage.slotConfig[r.id])))})})}),this.updateCmsPageDataMappingForLandingPage(),this.cmsPageState.setCurrentPage(n),this.cmsPage)})},updateCmsPageDataMappingForLandingPage(){this.cmsPageState.setCurrentMappingEntity("landing_page"),this.cmsPageState.setCurrentMappingTypes(this.cmsService.getEntityMappingTypes("landing_page")),this.cmsPageState.setCurrentDemoEntity(this.landingPage)},async setLandingPage(){this.isLoading=!0;try{if(this.landingPageId===null){Cicada.State.commit("cicadaApps/setSelectedIds",[]),await Cicada.State.dispatch("swCategoryDetail/setActiveLandingPage",{landingPage:null}),this.cmsPageState.resetCmsPageState();return}Cicada.State.commit("cicadaApps/setSelectedIds",[this.landingPageId]),await Cicada.State.dispatch("swCategoryDetail/loadActiveLandingPage",{repository:this.landingPageRepository,apiContext:Cicada.Context.api,id:this.landingPageId,criteria:this.landingPageCriteria}),this.cmsPageState.resetCmsPageState(),await this.getAssignedCmsPageForLandingPage(),await this.loadLandingPageCustomFieldSet()}catch{this.createNotificationError({title:this.$tc("global.default.error"),message:this.$tc("global.notification.unspecifiedSaveErrorMessage")})}finally{this.isLoading=!1}},setCategory(){return this.isLoading=!0,this.categoryId===null?(Cicada.State.commit("cicadaApps/setSelectedIds",[]),Cicada.State.dispatch("swCategoryDetail/setActiveCategory",{category:null}).then(()=>{this.cmsPageState.resetCmsPageState(),this.isLoading=!1})):(Cicada.State.commit("cicadaApps/setSelectedIds",[this.categoryId]),Cicada.State.dispatch("swCategoryDetail/loadActiveCategory",{repository:this.categoryRepository,apiContext:Cicada.Context.api,id:this.categoryId,criteria:this.categoryCriteria}).then(()=>(this.cmsPageState.resetCmsPageState(),Promise.resolve())).then(this.getAssignedCmsPage).then(this.loadCustomFieldSet).then(()=>{this.isLoading=!1}))},loadCustomFieldSet(){return this.isCustomFieldLoading=!0,this.customFieldSetRepository.search(this.customFieldSetCriteria).then(e=>this.$store.commit("swCategoryDetail/setCustomFieldSets",e)).finally(()=>{this.isCustomFieldLoading=!0})},loadLandingPageCustomFieldSet(){return this.isCustomFieldLoading=!0,this.customFieldSetRepository.search(this.customFieldSetLandingPageCriteria).then(e=>this.$store.commit("swCategoryDetail/setCustomFieldSets",e)).finally(()=>{this.isCustomFieldLoading=!0})},onSaveCategories(){return this.categoryRepository.save(this.category)},openChangeModal(e){this.nextRoute=e,this.isDisplayingLeavePageWarning=!0},onLeaveModalClose(){this.nextRoute=null,this.isDisplayingLeavePageWarning=!1},onLeaveModalConfirm(e){Cicada.State.dispatch("error/removeApiError",{expression:"category"}),this.forceDiscardChanges=!0,this.isDisplayingLeavePageWarning=!1,this.$nextTick(()=>{this.$router.push({name:e.name,params:e.params})})},cancelEdit(){this.resetCategory()},resetCategory(){this.$router.push({name:"sw.category.index"})},onChangeLanguage(e){this.currentLanguageId=e,this.landingPageId!==null&&this.setLandingPage(),this.setCategory()},abortOnLanguageChange(){return this.landingPage?this.landingPage?this.categoryRepository.hasChanges(this.landingPage):!1:this.category?this.categoryRepository.hasChanges(this.category):!1},saveOnLanguageChange(){return this.landingPage?this.onSaveLandingPage():this.onSave()},saveFinish(){this.isSaveSuccessful=!1},async onSave(){this.isSaveSuccessful=!1;const e=this.getCmsPageOverrides();if(c.isPlainObject(e)&&(this.category.slotConfig=g(e)),!this.entryPointOverwriteConfirmed&&(this.checkForEntryPointOverwrite(),this.showEntryPointOverwriteModal))return Promise.resolve();this.isLoading=!0,await this.updateSeoUrls();const t=await this.systemConfigApiService.getValues("core.cms");return this.defaultCategoryId=t["core.cms.default_category_cms_page"],this.category.cmsPageId===this.defaultCategoryId&&(this.category.cmsPageId=null),this.categoryRepository.save(this.category,{...Cicada.Context.api}).then(()=>(this.isSaveSuccessful=!0,this.entryPointOverwriteConfirmed=!1,this.setCategory())).catch(()=>{this.isLoading=!1,this.entryPointOverwriteConfirmed=!1,this.createNotificationError({message:this.$tc("global.notification.notificationSaveErrorMessageRequiredFieldsInvalid")})})},checkForEntryPointOverwrite(){this.entryPointOverwriteSalesChannels=new P("/sales_channel","sales_channel",C.api),this.category.navigationSalesChannels.forEach(e=>{e.navigationCategoryId!==null&&e.navigationCategoryId!==this.categoryId&&this.entryPointOverwriteSalesChannels.add(e)}),this.category.footerSalesChannels.forEach(e=>{e.footerCategoryId!==null&&e.footerCategoryId!==this.categoryId&&this.entryPointOverwriteSalesChannels.add(e)}),this.category.serviceSalesChannels.forEach(e=>{e.serviceCategoryId!==null&&e.serviceCategoryId!==this.categoryId&&this.entryPointOverwriteSalesChannels.add(e)})},cancelEntryPointOverwrite(){this.entryPointOverwriteSalesChannels=null},confirmEntryPointOverwrite(){this.entryPointOverwriteSalesChannels=null,this.entryPointOverwriteConfirmed=!0,this.$nextTick(()=>{this.onSave()})},onSaveLandingPage(){this.isSaveSuccessful=!1;const e=this.getCmsPageOverrides();return c.isPlainObject(e)&&(this.landingPage.slotConfig=g(e)),this.landingPageId!=="create"&&this.landingPage.salesChannels.length===0?(this.addLandingPageSalesChannelError(),Promise.resolve()):(this.isLoading=!0,this.landingPageRepository.save(this.landingPage,Cicada.Context.api).then(()=>(this.isSaveSuccessful=!0,this.landingPageId==="create"?(this.$router.push({name:"sw.category.landingPageDetail",params:{id:this.landingPage.id}}),Promise.resolve()):this.setLandingPage())).catch(()=>{if(this.isLoading=!1,this.landingPage.salesChannels.length===0){this.addLandingPageSalesChannelError();return}this.createNotificationError({message:this.$tc("global.notification.notificationSaveErrorMessageRequiredFieldsInvalid")})}))},addLandingPageSalesChannelError(){const e=new Cicada.Classes.CicadaError({code:"landing_page_sales_channel_blank",detail:"This value should not be blank.",status:"400"});Cicada.State.dispatch("error/addApiError",{expression:`landing_page.${this.landingPage.id}.salesChannels`,error:e}),this.createNotificationError({message:this.$tc("global.notification.notificationSaveErrorMessageRequiredFieldsInvalid")})},getCmsPageOverrides(){if(this.cmsPage===null)return null;this.deleteSpecifcKeys(this.cmsPage.sections);const{changes:e}=this.changesetGenerator.generate(this.cmsPage),t={};return e===null||c.isArray(e.sections)&&e.sections.forEach(s=>{c.isArray(s.blocks)&&s.blocks.forEach(n=>{c.isArray(n.slots)&&n.slots.forEach(a=>{t[a.id]=a.config})})}),t},deleteSpecifcKeys(e){e&&e.forEach(t=>{t.blocks&&t.blocks.forEach(s=>{s.slots&&s.slots.forEach(n=>{n.config&&Object.values(n.config).forEach(a=>{a.entity&&delete a.entity,a.hasOwnProperty("required")&&delete a.required,a.type&&delete a.type})})})})},updateSeoUrls(){if(!Cicada.State.list().includes("swSeoUrl"))return Promise.resolve();const e=Cicada.State.getters["swSeoUrl/getNewOrModifiedUrls"]();return Promise.all(e.map(t=>t.seoPathInfo?(t.isModified=!0,this.seoUrlService.updateCanonicalUrl(t,t.languageId)):Promise.resolve()))},onLandingPageDelete(){Cicada.State.commit("swCategoryDetail/setLandingPagesToDelete",{landingPagesToDelete:null})},onCategoryDelete(){Cicada.State.commit("swCategoryDetail/setCategoriesToDelete",{categoriesToDelete:null})}}};export{v as default};
//# sourceMappingURL=index-DOwKbm3I.js.map
