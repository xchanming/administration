{"version":3,"file":"index-ebQaV0SO.js","sources":["../../../app/administration/src/app/component/utils/sw-upload-listener/index.js"],"sourcesContent":["import { UploadEvents } from 'src/core/service/api/media.api.service';\n\nconst { Component, Mixin, Context } = Cicada;\nconst utils = Cicada.Utils;\n\n/**\n * @private\n */\n\nfunction isIllegalFileNameException(error) {\n    return error.response.data.errors.some((err) => {\n        return err.code === 'CONTENT__MEDIA_ILLEGAL_FILE_NAME';\n    });\n}\n\nfunction isDuplicationException(error) {\n    return error.response.data.errors.some((err) => {\n        return err.code === 'CONTENT__MEDIA_DUPLICATED_FILE_NAME';\n    });\n}\n\nfunction isIllegalUrlException(error) {\n    return error.response.data.errors.some((err) => {\n        return err.code === 'CONTENT__MEDIA_ILLEGAL_URL';\n    });\n}\n\n/**\n * @public\n * @description\n * component that listens to mutations of the upload store and transforms them back into the vue.js event system.\n * @status ready\n * @event media-upload-add { UploadTask[]: data }\n * @event media-upload-finish { string: targetId }\n * @event media-upload-fail UploadTask UploadTask\n * @event media-upload-cancel UploadTask UploadTask\n * @example code-only\n * @component-example\n * <sw-upload-listener @sw-uploads-added=\"...\"></sw-upload-listener>\n */\n// eslint-disable-next-line sw-deprecation-rules/private-feature-declarations\nComponent.register('sw-upload-listener', {\n    template: '<div style=\"display: none\"></div>',\n\n    compatConfig: Cicada.compatConfig,\n\n    inject: [\n        'repositoryFactory',\n        'mediaService',\n    ],\n\n    mixins: [\n        Mixin.getByName('notification'),\n    ],\n\n    props: {\n        uploadTag: {\n            type: String,\n            required: true,\n        },\n\n        autoUpload: {\n            type: Boolean,\n            required: false,\n            default: false,\n        },\n    },\n\n    data() {\n        return {\n            id: utils.createId(),\n            notificationId: null,\n        };\n    },\n\n    computed: {\n        mediaRepository() {\n            return this.repositoryFactory.create('media');\n        },\n    },\n\n    watch: {\n        uploadTag(newVal, oldVal) {\n            this.mediaService.removeListener(oldVal, this.convertStoreEventToVueEvent);\n            this.mediaService.addListener(newVal, this.convertStoreEventToVueEvent);\n        },\n    },\n\n    created() {\n        this.createdComponent();\n    },\n\n    unmounted() {\n        this.destroyedComponent();\n    },\n\n    methods: {\n        createdComponent() {\n            this.mediaService.addListener(this.uploadTag, this.convertStoreEventToVueEvent);\n        },\n\n        destroyedComponent() {\n            this.mediaService.removeListener(this.uploadTag, this.convertStoreEventToVueEvent);\n        },\n\n        convertStoreEventToVueEvent({ action, uploadTag, payload }) {\n            if (this.uploadTag !== uploadTag) {\n                return;\n            }\n\n            if (action === UploadEvents.UPLOAD_ADDED) {\n                if (this.autoUpload === true) {\n                    this.syncEntitiesAndRunUploads();\n                    return;\n                }\n\n                this.$emit(UploadEvents.UPLOAD_ADDED, payload);\n                return;\n            }\n\n            if (action === UploadEvents.UPLOAD_FINISHED) {\n                this.updateSuccessNotification(uploadTag, payload);\n                this.$emit(UploadEvents.UPLOAD_FINISHED, payload);\n                return;\n            }\n\n            if (action === UploadEvents.UPLOAD_FAILED) {\n                if (\n                    payload.successAmount + payload.failureAmount === payload.totalAmount &&\n                    payload.totalAmount !== payload.failureAmount\n                ) {\n                    this.updateSuccessNotification(uploadTag, payload);\n                }\n                if (isDuplicationException(payload.error)) {\n                    this.$emit(UploadEvents.UPLOAD_FAILED, payload);\n                    return;\n                }\n\n                this.handleError(payload).then(() => {\n                    this.$emit(UploadEvents.UPLOAD_FAILED, payload);\n                });\n            }\n\n            if (action === UploadEvents.UPLOAD_CANCELED) {\n                this.$emit(UploadEvents.UPLOAD_CANCELED, payload);\n            }\n        },\n\n        async handleError(payload) {\n            this.showErrorNotification(payload);\n            const updatedMedia = await this.mediaRepository.get(payload.targetId, Context.api);\n\n            if (!updatedMedia.hasFile) {\n                await this.mediaRepository.delete(updatedMedia.id, Context.api);\n            }\n        },\n\n        updateSuccessNotification(uploadTag, payload) {\n            const notification = {\n                title: this.$root.$tc('global.default.success'),\n                message: this.$root.$tc(\n                    payload.customMessage ?? 'global.sw-media-upload.notification.success.message',\n                    payload.successAmount,\n                    {\n                        count: payload.successAmount,\n                        total: payload.totalAmount,\n                    },\n                ),\n                growl: payload.successAmount + payload.failureAmount === payload.totalAmount,\n            };\n\n            if (payload.successAmount + payload.failureAmount === payload.totalAmount) {\n                notification.title = this.$root.$tc('global.default.success');\n            }\n\n            if (this.notificationId !== null) {\n                Cicada.State.dispatch('notification/updateNotification', {\n                    uuid: this.notificationId,\n                    ...notification,\n                }).then(() => {\n                    if (payload.successAmount + payload.failureAmount === payload.totalAmount) {\n                        this.notificationId = null;\n                    }\n                });\n                return;\n            }\n\n            Cicada.State.dispatch('notification/createNotification', {\n                variant: 'success',\n                ...notification,\n            }).then((newNotificationId) => {\n                if (payload.successAmount + payload.failureAmount < payload.totalAmount) {\n                    this.notificationId = newNotificationId;\n                }\n            });\n        },\n\n        showErrorNotification(payload) {\n            if (isIllegalFileNameException(payload.error)) {\n                this.createNotificationError({\n                    title: this.$root.$tc('global.default.error'),\n                    message: this.$root.$tc('global.sw-media-upload.notification.illegalFilename.message', 0, {\n                        fileName: payload.fileName,\n                    }),\n                });\n            } else if (isIllegalUrlException(payload.error)) {\n                this.createNotificationError({\n                    title: this.$root.$tc('global.sw-media-upload.notification.illegalFileUrl.title'),\n                    message: this.$root.$tc('global.sw-media-upload.notification.illegalFileUrl.message', 0),\n                });\n            } else {\n                this.createNotificationError({\n                    title: this.$root.$tc('global.default.error'),\n                    message: this.$root.$tc('global.sw-media-upload.notification.failure.message'),\n                });\n            }\n        },\n\n        syncEntitiesAndRunUploads() {\n            this.mediaService.runUploads(this.uploadTag);\n        },\n    },\n});\n"],"names":["Component","Mixin","Context","utils","isIllegalFileNameException","error","err","isDuplicationException","isIllegalUrlException","newVal","oldVal","action","uploadTag","payload","UploadEvents","updatedMedia","notification","newNotificationId"],"mappings":"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"}