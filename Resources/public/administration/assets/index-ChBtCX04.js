const r=`{% block sw_order_promotion_field %} <div class="sw-order-promotion-field"> {% block sw_order_promotion_field_codes %} <sw-order-promotion-tag-field v-model:value="promotionCodeTags" :disabled="!hasLineItem || isLoading || !acl.can('order.editor') || undefined" :currency="currency" :label="$tc('sw-order.detailsTab.promotionsField.labelPromotions')" :placeholder="$tc('sw-order.detailsTab.promotionsField.placeholderPromotions')" :error="promotionError" @on-remove-code="onRemoveExistingCode" /> {% endblock %} {% block sw_order_promotion_field_switch %} <sw-switch-field v-model:value="disabledAutoPromotions" :disabled="isLoading || !acl.can('order.editor') || undefined" :label="$tc('sw-order.detailsTab.promotionsField.labelToggleAutomaticPromotions')" /> {% endblock %} </div> {% endblock %}`,{Component:a}=Cicada,{ChangesetGenerator:n}=Cicada.Data,{mapState:s}=a.getComponentHelper(),d={template:r,compatConfig:Cicada.compatConfig,inject:{swOrderDetailOnLoadingChange:{from:"swOrderDetailOnLoadingChange",default:null},swOrderDetailOnError:{from:"swOrderDetailOnError",default:null},swOrderDetailOnReloadEntityData:{from:"swOrderDetailOnReloadEntityData",default:null},repositoryFactory:{from:"repositoryFactory",default:null},orderService:{from:"orderService",default:null},acl:{from:"acl",default:null}},emits:["loading-change","error","reload-entity-data"],mixins:["notification"],props:{isLoading:{type:Boolean,required:!1,default:!1}},data(){return{promotionError:null,disabledAutoPromotions:!1}},computed:{...s("swOrderDetail",["order","versionContext"]),orderLineItemRepository(){return this.repositoryFactory.create("order_line_item")},hasLineItem(){return this.order.lineItems.filter(t=>t.hasOwnProperty("id")).length>0},currency(){return this.order.currency},manualPromotions(){return this.order.lineItems.filter(t=>t.type==="promotion"&&t.referencedId!==null)},automaticPromotions(){return this.order.lineItems.filter(t=>t.type==="promotion"&&t.referencedId===null)},promotionCodeTags:{get(){return this.manualPromotions.map(t=>t.payload)},set(t){const e=this.manualPromotions;if(this.promotionError=null,t.length<e.length)return;const i=e.length,o=t[i];t.length>e.length&&this.onSubmitCode(o.code),i>0&&o.isInvalid&&(this.promotionError={detail:this.$tc("sw-order.createBase.textInvalidPromotionCode")})}},hasAutomaticPromotions(){return this.automaticPromotions.length>0},changesetGenerator(){return new n},hasOrderUnsavedChanges(){return this.changesetGenerator.generate(this.order).changes!==null}},watch:{disabledAutoPromotions(t,e){e!==this.hasAutomaticPromotions&&this.toggleAutomaticPromotions(t)},automaticPromotions(){this.disabledAutoPromotions=!this.hasAutomaticPromotions}},created(){this.createdComponent()},methods:{createdComponent(){this.disabledAutoPromotions=!this.hasAutomaticPromotions},deleteAutomaticPromotions(){if(this.automaticPromotions.length===0)return Promise.resolve();const t=[];return this.automaticPromotions.forEach(e=>{t.push(this.orderLineItemRepository.delete(e.id,this.versionContext))}),Promise.all(t).then(()=>{this.automaticPromotions.forEach(e=>{this.createNotificationSuccess({message:this.$tc("sw-order.detailBase.textPromotionRemoved",0,{promotion:e.label})})})}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},toggleAutomaticPromotions(t){if(this.$emit("loading-change",!0),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!0),this.hasOrderUnsavedChanges){this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.handleUnsavedOrderChangesResponse(),this.$nextTick(()=>{this.disabledAutoPromotions=!t});return}this.deleteAutomaticPromotions().then(()=>this.orderService.toggleAutomaticPromotions(this.order.id,this.order.versionId,t)).then(e=>{this.handlePromotionResponse(e),this.$emit("reload-entity-data"),this.swOrderDetailOnReloadEntityData&&this.swOrderDetailOnReloadEntityData()}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},onSubmitCode(t){if(this.$emit("loading-change",!0),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!0),this.hasOrderUnsavedChanges){this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.handleUnsavedOrderChangesResponse();return}this.orderService.addPromotionToOrder(this.order.id,this.order.versionId,t).then(e=>{this.handlePromotionResponse(e),this.$emit("reload-entity-data"),this.swOrderDetailOnReloadEntityData&&this.swOrderDetailOnReloadEntityData()}).catch(e=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",e),this.swOrderDetailOnError&&this.swOrderDetailOnError(e)})},handlePromotionResponse(t){Object.values(t.data.errors).forEach(e=>{switch(e.level){case 0:{this.createNotificationSuccess({message:e.message});break}case 10:{this.createNotificationWarning({message:e.message});break}default:{this.createNotificationError({message:e.message});break}}})},handleUnsavedOrderChangesResponse(){this.createNotificationWarning({message:this.$tc("sw-order.detailBase.textUnsavedChanges",0)})},onRemoveExistingCode(t){if(this.$emit("loading-change",!0),this.hasOrderUnsavedChanges){this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.handleUnsavedOrderChangesResponse();return}const e=this.order.lineItems.find(i=>i.type==="promotion"&&i.payload.code===t.code);this.orderLineItemRepository.delete(e.id,this.versionContext).then(()=>{this.$emit("reload-entity-data"),this.swOrderDetailOnReloadEntityData&&this.swOrderDetailOnReloadEntityData()}).catch(i=>{this.$emit("loading-change",!1),this.swOrderDetailOnLoadingChange&&this.swOrderDetailOnLoadingChange(!1),this.$emit("error",i),this.swOrderDetailOnError&&this.swOrderDetailOnError(i)})},getLineItemByPromotionCode(t){return this.order.lineItems.find(e=>e.type==="promotion"&&e.payload.code===t)}}};export{d as default};
//# sourceMappingURL=index-ChBtCX04.js.map
