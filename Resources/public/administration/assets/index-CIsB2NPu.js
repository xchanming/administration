const s=`{% block sw_product_media_form %} <div class="sw-product-media-form" :class="{ 'is--disabled': disabled }" > {% block sw_product_media_form_upload %} <sw-upload-listener v-if="!isLoading" :upload-tag="product.id" auto-upload @media-upload-finish="successfulUpload" @media-upload-fail="onUploadFailed" /> <sw-media-upload-v2 v-if="!isLoading && acl.can('product.editor')" variant="regular" :upload-tag="product.id" :scroll-target="$parent.$el" :default-folder="product.getEntityName()" :file-accept="fileAccept" @media-upload-sidebar-open="onOpenMedia" /> {% endblock %} {% block sw_product_media_form_grid %} <div class="sw-product-media-form__previews"> <div class="sw-product-media-form__cover-container sw-product-media-form__column"> {% block sw_product_media_form_cover_preview %} <div v-if="product.cover || cover" class="sw-product-media-form__preview-cover" > <div class="preview-cover"> {% block sw_product_media_form_cover_image %} <sw-media-preview-v2 :key="cover ? cover.media?.url : product.cover.media?.url" class="sw-product-media-form__cover-image" :source="cover ? cover.mediaId : product.cover.mediaId" /> {% endblock %} <span>{{ $tc('sw-product.mediaForm.coverSubline') }}</span> </div> </div> <div v-else class="sw-product-media-form__cover-image is--placeholder" > {{ $tc('sw-product.mediaForm.coverSubline') }} </div> {% endblock %} </div> <div v-if="!isLoading" class="sw-product-media-form__grid sw-product-media-form__column" :style="gridAutoRows" > {% block sw_product_media_form_grid_items %} <sw-product-image v-for="mediaItem in mediaItems" :key="mediaItem.id" v-draggable="{ dragGroup: 'product-media', data: mediaItem, onDragEnter: onMediaItemDragSort }" v-droppable="{ dragGroup: 'product-media', data: mediaItem }" :is-cover="isCover(mediaItem)" :is-spatial="isSpatial(mediaItem)" :is-ar-ready="isArReady(mediaItem)" :is-placeholder="mediaItem.isPlaceholder" :media-id="mediaItem.mediaId" :show-cover-label="showCoverLabel" @sw-product-image-delete="removeFile(mediaItem)" @sw-product-image-cover="markMediaAsCover(mediaItem)" /> {% endblock %} </div> <sw-loader v-else /> </div> {% endblock %} </div> {% endblock %}`,{Mixin:c}=Shopware,u={template:s,inject:["repositoryFactory","acl","systemConfigApiService"],emits:["media-open"],mixins:[c.getByName("notification")],props:{disabled:{type:Boolean,required:!1,default:!1},isInherited:{type:Boolean,required:!1,default:!1},fileAccept:{type:String,required:!1,default:"*/*"}},data(){return{showCoverLabel:!0,isMediaLoading:!1,columnCount:5,columnWidth:90,globalIsArReady:!1}},computed:{product(){const e=Shopware.Store.get("swProductDetail");return this.isInherited?e.parentProduct:e.product},mediaItems(){const e=this.productMedia.slice(),i=this.getPlaceholderCount(this.columnCount);if(i===0)return e;for(let t=0;t<i;t+=1)e.push(this.createPlaceholderMedia(e));return e},cover(){if(!this.product)return null;const e=this.product.cover?this.product.cover.mediaId:this.product.coverId;return this.product.media.find(i=>i.id===e)},isStoreLoading(){return Shopware.Store.get("swProductDetail").isLoading},isLoading(){return this.isMediaLoading||this.isStoreLoading},productMediaRepository(){return this.repositoryFactory.create("product_media")},mediaRepository(){return this.repositoryFactory.create("media")},productMedia(){return this.product?this.product.media:[]},productMediaStore(){return this.product.getAssociation("media")},gridAutoRows(){return`grid-auto-rows: ${this.columnWidth}`},currentCoverID(){return this.productMedia.find(i=>i.media.id===this.product.coverId).id}},created(){this.onCreated()},methods:{onCreated(){this.systemConfigApiService.getValues("core.media").then(e=>{this.globalIsArReady=e["core.media.defaultEnableAugmentedReality"]}).catch(e=>{throw e})},onOpenMedia(){this.$emit("media-open")},updateColumnCount(){this.$nextTick(()=>{if(this.isLoading)return!1;const e=window.getComputedStyle(this.$refs.grid,null).getPropertyValue("grid-template-columns").split(" ");return this.columnCount=e.length,this.columnWidth=e[0],!0})},getPlaceholderCount(e){this.productMedia.length+3<e*2&&(e*=2);let i=e;return this.productMedia.length!==0&&(i=e-this.productMedia.length%e,i===e)?0:i},createPlaceholderMedia(e){return{isPlaceholder:!0,isCover:e.length===0,media:{isPlaceholder:!0,name:""},mediaId:e.length.toString()}},buildProductMedia(e){this.isLoading=!0;const i=this.productMediaStore.create();return i.mediaId=e,this.productMedia.length===0?(i.position=0,this.product.cover=i,this.product.coverId=i.id):i.position=this.productMedia.length+1,this.isLoading=!1,i},async successfulUpload({targetId:e}){var d;const i=this.product.media.find(r=>r.mediaId===e);if(i){const r=await this.mediaRepository.get(e),o=this.createMediaAssociation(e);o.media=r;const a=((d=this.product.cover)==null?void 0:d.id)===i.id;this.product.media.remove(i.id),this.product.media.add(o),a&&(this.product.coverId=o.id,this.product.cover=o);return}const t=this.createMediaAssociation(e);this.product.media.add(t)},createMediaAssociation(e){const i=this.productMediaRepository.create();return i.productId=this.product.id,i.mediaId=e,this.product.media.length<=0?(i.position=0,this.product.coverId=i.id):i.position=this.product.media.length,i},onUploadFailed(e){const i=this.product.media.find(t=>t.mediaId===e.targetId);i&&(this.product.coverId===i.id&&(this.product.coverId=null),this.product.media.remove(i.id)),this.product.isLoading=!1},removeCover(){this.product.cover=null,this.product.coverId=null},isCover(e){const i=this.product.cover?this.product.cover.id:this.product.coverId;return this.product.media.length===0||e.isPlaceholder?!1:e.id===i},isSpatial(e){var i,t,d;return((i=e.media)==null?void 0:i.fileExtension)==="glb"||!!((d=(t=e.media)==null?void 0:t.url)!=null&&d.endsWith(".glb"))},isArReady(e){var i,t,d;return((d=(t=(i=e.media)==null?void 0:i.config)==null?void 0:t.spatial)==null?void 0:d.arReady)??this.globalIsArReady},removeFile(e){this.product.coverId===e.id&&(this.product.cover=null,this.product.coverId=null),this.product.coverId===null&&this.product.media.length>0&&(this.product.coverId=this.product.media.first().id),this.product.media.remove(e.id)},markMediaAsCover(e){this.product.cover=e,this.product.coverId=e.id,this.product.media.moveItem(e.position,0),this.updateMediaItemPositions()},onDropMedia(e){if(this.product.media.find(t=>t.mediaId===e.id))return;const i=this.createMediaAssociation(e.mediaItem.id);this.product.media.length===0&&(i.position=0,this.product.cover=i,this.product.coverId=i.id),this.product.media.add(i)},onMediaItemDragSort(e,i,t){t!==!0||e.id===this.product.coverId&&e.position===0||i.id===this.product.coverId&&i.position===0||(this.product.media.moveItem(e.position,i.position),this.updateMediaItemPositions())},updateMediaItemPositions(){this.productMedia.forEach((e,i)=>{e.position=i})}}};export{u as default};
