const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C3jRtoXN.js","assets/store-D_-eM0q8.js","assets/sw-bulk-edit.store-6UtElGbe.js","assets/index-NSbFRA8V.css","assets/index-CmvjEvre.js","assets/index-emGdm4kx.css","assets/index-B7VNd1OW.js","assets/index-LbBSsmeX.css","assets/index-Ck6-WAto.js","assets/index-IxbZOfGQ.css","assets/index-BurtPUY5.js","assets/index-0oO4otq6.css","assets/index-D9koAEil.js","assets/index-BDCG3RT0.css","assets/index-BRTXT8tk.js","assets/index-CwCXCFH7.css","assets/index-CV9l5lDq.js","assets/index-Bv2xAWDm.css","assets/index-BtmA_pwY.js","assets/index-Tpuku_Pw.css","assets/index-C8oxf1Mq.js","assets/index-B9oxrMTr.css","assets/index-Cx3rh9k9.js","assets/index-CWIQqWuV.css","assets/index-0ah09VFe.js","assets/index-gK9oCgZf.css","assets/index-DjO6XcPo.js","assets/index-Fu1HihgL.css"])))=>i.map(i=>d[i]);
import{_ as h}from"./administration-CcAM5iN0.js";import{R as b}from"./retry.helper-BDu6eVqs.js";const{object:V}=Shopware.Utils,{Criteria:v}=Shopware.Data,E=Object.freeze({OVERWRITE:"overwrite",CLEAR:"clear",ADD:"add",REMOVE:"remove"}),{types:C}=Shopware.Utils,{getObjectDiff:L}=Shopware.Utils.object;class R{constructor(){this.syncService=Shopware.Service("syncService"),this.repositoryFactory=Shopware.Service("repositoryFactory"),this.entityName=null,this.entityIds=[],this.groupedPayload={upsert:{},delete:{}}}async buildBulkSyncPayload(t){const e=Shopware.EntityDefinition.get(this.entityName);if(!e)throw Error(`No schema found for entity ${this.entityName}`);return this.groupedPayload.delete[this.entityName]={},this.groupedPayload.upsert[this.entityName]={},await Promise.all(t.map(async i=>{if(!Object.values(E).includes(i.type))return;const r=e.getField(i.field);if(!r){Shopware.Utils.debug.warn("Entity factory",`Property ${this.entityName}.${i.field} not found`);return}const s=e.isOneToOneAssociation(r);if(e.isToManyAssociation(r)||s)try{await this._handleAssociationChange(r,i,s);return}catch(n){Shopware.Utils.debug.warn(n);return}const o=this._castDefaultValueIfNecessary(i,r.type);this.entityIds.forEach(n=>{var a;(a=this.groupedPayload.upsert[this.entityName])[n]??(a[n]={id:n}),this.groupedPayload.upsert[this.entityName][n][i.field]=o})})),this._transformSyncPayload(this.groupedPayload)}_transformSyncPayload(t){const e={};return Object.keys(t).forEach(i=>{const r=t[i];Object.keys(r).length!==0&&Object.keys(r).forEach(s=>{const o=Object.values(r[s]);if(o.length===0)return;const n=`${i}-${s}`;e[n]??(e[n]={action:i,entity:s,payload:[]}),e[n].payload.push(...o.flat())})}),e}async _handleAssociationChange(t,e,i=!1){const{mapping:r,entity:s,local:o,reference:n,localField:a,referenceField:l}=t,p=!!r;let u;e.referenceEntity=r??s,this.groupedPayload.delete[e.referenceEntity]={},this.groupedPayload.upsert[e.referenceEntity]={};const d=Array.isArray(e.value)?e.value:[e.value];e.value=d.filter(Boolean),p?(e.localKey=o,e.referenceKey=n,u=await this._fetchManyToManyAssociated(t,e)):(e.localKey=a,e.referenceKey=l,u=await this._fetchOneToManyAssociated(t,e));const{referenceEntity:y,localKey:f,referenceKey:c,type:w}=e;if([E.CLEAR,E.REMOVE].includes(w)){this.groupedPayload.delete[y]={...this._transformDeletePayload(u,f,c)};return}w===E.OVERWRITE&&(this.groupedPayload.delete[y]={...this._transformDeletePayload(u,f,c)}),p?this._detectManyToManyChange(e,u):i?this._detectOneToOneChange(e,u):this._detectOneToManyChange(e,u)}_detectOneToManyChange(t,e){const{referenceEntity:i,referenceKey:r,localKey:s,mappingReferenceField:o,value:n,type:a}=t,l=this._getEditableProperties(i);o&&l.push(o),n.forEach(p=>{const u=p;p=V.pick(p,l),this.entityIds.forEach(d=>{var S;const y={...p};y[r]=d;const c=o?`${u[o??s]}.${d}`:d,w=e[c]??[];if(o&&a===E.ADD&&w.length>0)return;let g=null;a===E.OVERWRITE&&w.length===1&&(g={...w[0]},e[c].shift(),delete this.groupedPayload.delete[i][c]);const P=this._getOneToManyChange(y,s,o,g);P===null||Object.keys(P).length===0||((S=this.groupedPayload.upsert[i])[c]??(S[c]=[]),this.groupedPayload.upsert[i][c].push(P))})})}_detectOneToOneChange(t,e){const{referenceEntity:i,referenceKey:r,localKey:s,value:o}=t,n=this._getEditableProperties(i);o.forEach(a=>{a=V.pick(a,n),this.entityIds.forEach(l=>{var c;const p={...a};p[r]=l;const u=l,d=e[u]??[];let y=null;d.length===1&&(y={...d[0]},e[u].shift(),delete this.groupedPayload.delete[i][u]);const f=this._getOneToManyChange(p,s,null,y);f===null||Object.keys(f).length===0||((c=this.groupedPayload.upsert[i])[u]??(c[u]=[]),this.groupedPayload.upsert[i][u].push(f))})})}_getOneToManyChange(t,e,i,r=null){const s={};i&&(s[i]=t[i]),r&&(s[e]=r[e],delete t[e],delete t[i]),Object.keys(t).forEach(n=>{(!r||t[n]!==void 0&&this._isFieldValueChanged(t[n],r[n]))&&(s[n]=t[n])}),r&&delete s[i];const o=Object.keys(s).some(n=>n!==e);return r&&!o?null:s}_detectManyToManyChange(t,e){const{referenceEntity:i,referenceKey:r,localKey:s,value:o}=t;o.forEach(n=>{this.entityIds.forEach(a=>{const l=n.id,p=`${l}.${a}`;if(e[p]){delete this.groupedPayload.delete[i][p];return}this.groupedPayload.upsert[i][p]=[{[r]:l,[s]:a}]})})}_castDefaultValueIfNecessary(t,e){const{value:i,type:r}=t;return r===E.CLEAR?["int","float"].includes(e)?0:null:i===""||typeof i>"u"?null:i}async _fetchOneToManyAssociated(t,e,i=1,r={}){const{entity:s,referenceField:o}=t,n=new v(i,500);if(n.addFilter(v.equalsAny(o,this.entityIds)),e.mappingReferenceField&&e.type===E.REMOVE){const u=e.value.map(d=>d[e.mappingReferenceField]);u&&u.filter(Boolean)&&n.addFilter(v.equalsAny(e.mappingReferenceField,u))}const l=await this.repositoryFactory.create(s).search(n);l.forEach(u=>{let d=u[o];if(e.mappingReferenceField){const{[o]:y,[e.mappingReferenceField]:f}=u;d=`${f}.${y}`}r.hasOwnProperty(d)?r[d].push(u):r[d]=[u]});const p=Object.keys(r).reduce((u,d)=>u+r[d].length,0);return l.total>p?this._fetchOneToManyAssociated(t,e,i+1,r):r}async _fetchManyToManyAssociated(t,e,i=1,r={}){const{referenceField:s,mapping:o,local:n,reference:a}=t,l=e.type===E.REMOVE?e.value.map(f=>f[s]):null,p=new v(i,500);p.addFilter(v.equalsAny(n,this.entityIds)),l&&l.filter(Boolean)&&p.addFilter(v.equalsAny(a,l));const d=await this.repositoryFactory.create(o).searchIds(p);return d.data.forEach(f=>{const{[n]:c,[a]:w}=f,g=`${w}.${c}`;r[g]=[f]}),d.total>Object.keys(r).length?this._fetchManyToManyAssociated(t,e,i+1,r):r}_getEditableProperties(t){const e=Shopware.EntityDefinition.get(t),i=e.filterProperties(r=>e.isScalarField(r)||e.isJsonField(r)||!r.flags||r.flags.write_protected);return Object.keys(i).filter(r=>!["updatedAt","createdAt"].includes(r))}_transformDeletePayload(t,e,i){const r={};return Object.keys(t).forEach(s=>{(t[s]??[]).forEach(n=>{const{id:a,[e]:l,[i]:p}=n;r[s]??(r[s]=[]),a?r[s].push({id:a}):r[s].push({[e]:l,[i]:p})})}),r}_isFieldValueChanged(t,e){return C.isObject(t)&&C.isObject(e)?Object.keys(L(t,e)).length>0:!C.isEqual(t,e)}}const O=Shopware.Utils.types,{Service:F,Application:x}=Shopware,{Criteria:j}=Shopware.Data,{cloneDeep:$}=Shopware.Utils.object;class B extends R{constructor(){super(),this.name="bulkEditProductHandler",this.calculatePriceService=x.getContainer("factory").apiService.getByName("calculate-price"),this.entityName="product",this.entityIds=[],this.products={}}async bulkEdit(t,e){var l,p,u;this.entityIds=t;const i=(l=e.find(d=>d.field==="taxId"))==null?void 0:l.value,r=(p=e.find(d=>d.field==="price"))==null?void 0:p.value,s=(u=e.find(d=>d.field==="purchasePrices"))==null?void 0:u.value;let o=[];(i||r||s)&&await this.getProducts(),this.shouldRecalculateTax(i,r,s)&&(o=await this.recalculatePrices(i,r,s),e=e.filter(d=>d.field!=="taxId")),(r||s)&&(o=this.updatePriceDirectly(r,s,o),e=e.filter(d=>d.field!=="price"&&d.field!=="purchasePrices"));const n=await this.buildBulkSyncPayload(e);if(o.length&&(!O.isEmpty(n)&&"upsert-product"in n?n["upsert-product"].payload=this.mapProductPricesToSyncPayload(n["upsert-product"].payload,o):n["upsert-product"]={action:"upsert",entity:"product",payload:o}),O.isEmpty(n))return Promise.resolve({data:[]});const a=JSON.stringify(n,(d,y)=>y===void 0?null:y);return b.retry(()=>this.syncService.sync(a,{},{"single-operation":1,"sw-language-id":Shopware.Context.api.languageId}))}shouldRecalculateTax(t,e,i){return t&&this.isNullPrice(e,i)}isNullPrice(t,e){return!t||!t[0].listPrice||!t[0].regulationPrice||!e}mapProductPricesToSyncPayload(t,e){const i=[];return t.forEach(r=>{const s=e.find(o=>o.id===r.id);s&&(r={...r,...s},e=e.filter(o=>o.id!==r.id)),i.push(r)}),i.concat(e)}getProducts(){const t=F("repositoryFactory").create("product"),e=new j(1,25);return e.setIds(this.entityIds),t.search(e,Shopware.Context.api).then(i=>{this.products=i})}async recalculatePrices(t,e,i){const r={},s={},o={},n={},a=this.products.filter(c=>c.taxId!==t);a.forEach(c=>{var w,g,P,S,k,A,D,M;if(!e){const _=(g=(w=c.price)==null?void 0:w.filter(m=>m.linked))==null?void 0:g.map(m=>this.getRecalculatePrice(m));O.isEmpty(_)||(r[c.id]=_)}if(!e||!e[0].listPrice){const _=(S=(P=c.price)==null?void 0:P.filter(m=>{var T;return(T=m.listPrice)==null?void 0:T.linked}))==null?void 0:S.map(m=>this.getRecalculatePrice(m.listPrice));O.isEmpty(_)||(s[c.id]=_)}if(!e||!e[0].regulationPrice){const _=(A=(k=c.price)==null?void 0:k.filter(m=>{var T;return(T=m.regulationPrice)==null?void 0:T.linked}))==null?void 0:A.map(m=>this.getRecalculatePrice(m.regulationPrice));O.isEmpty(_)||(o[c.id]=_)}if(!i){const _=(M=(D=c.purchasePrices)==null?void 0:D.filter(m=>m.linked))==null?void 0:M.map(m=>this.getRecalculatePrice(m));O.isEmpty(_)||(n[c.id]=_)}});const l=await Promise.all([this.calculatePrices(t,r),this.calculatePrices(t,s),this.calculatePrices(t,o),this.calculatePrices(t,n)]),p=l[0],u=l[1],d=l[2],y=l[3],f=[];return a.forEach(c=>{const w=p[c.id]??[],g=u[c.id]??[],P=d[c.id]??[],S=y[c.id]??[],k={id:c.id,taxId:t};c.price&&(k.price=this.getCalculatedPrices(c.price,w,g,P)),c.purchasePrices&&(k.purchasePrices=this.getCalculatedPrices(c.purchasePrices,S)),f.push(k)}),f}getRecalculatePrice(t){return{price:t.gross,currencyId:t.currencyId}}async calculatePrices(t,e){return e===null||Object.keys(e).length===0?{}:this.calculatePriceService.calculatePrices(t,e)}getCalculatedPrices(t,e,i=[],r=[]){const s=[];return t.forEach(o=>{const{currencyId:n,listPrice:a,regulationPrice:l}=o;if(o.linked&&e[n]&&(o.net=o.gross-this.getTax(e[n].calculatedTaxes)),a!=null&&a.linked&&i[n]&&(o.listPrice.net=a.gross-this.getTax(i[n].calculatedTaxes)),l!=null&&l.linked&&r[n]){const p=r[n].calculatedTaxes;o.regulationPrice.net=l.gross-this.getTax(p)}s.push(o)}),s}getTax(t){let e=0;return t.forEach(i=>{e+=i.tax}),e}updatePriceDirectly(t,e,i){const r=[];return this.products.forEach(s=>{const o=i.find(a=>a.id===s.id),n=o??{id:s.id};if(t){const a=(o==null?void 0:o.price)??s.price;n.price=this.updatePrice(t[0],a)}e&&(n.purchasePrices=this.updatePrice(e[0],s.purchasePrices)),o&&(i=i.filter(a=>a.id!==s.id)),r.push(n)}),r.concat(i)}updatePrice(t,e){const i=t.currencyId;let r=[];const s=(e==null?void 0:e.find(n=>n.currencyId===i))??null,o=this.getPrice(t,s);return e&&(r=e.filter(n=>n.currencyId!==i)),r.push(o),r}getPrice(t,e){const i=e==null?void 0:e.listPrice,r=e==null?void 0:e.regulationPrice;let s=$(t);return s=this.formatPrice(s,e),s.listPrice?s.listPrice=this.formatPrice(s.listPrice,i):i&&(s.listPrice=i),s.regulationPrice?s.regulationPrice=this.formatPrice(s.regulationPrice,r):r&&(s.regulationPrice=r),s}formatPrice(t,e){return t.gross===null&&(t.linked=!1,t.gross=(e==null?void 0:e.gross)??0),t.net===null&&(t.linked=!1,t.net=(e==null?void 0:e.net)??0),t}}const{Criteria:N}=Shopware.Data,{types:H}=Shopware.Utils;class K extends R{constructor(){super(),this.name="BulkEditOrderHandler",this.entityIds=[],this.orderStateMachineService=Shopware.Service("orderStateMachineService"),this.orderRepository=Shopware.Service("repositoryFactory").create("order"),this.entityName="order"}async bulkEditStatus(t,e){this.entityIds=t;let i=[];const r=Shopware.Store.get("swBulkEdit").isFlowTriggered,s=await this.orderRepository.search(this.getCriteria());return e.forEach(o=>{o.value&&(i=s.map(n=>{var l,p;const a={documentTypes:o.documentTypes,skipSentDocuments:o.skipSentDocuments,sendMail:o.sendMail};switch(o.field){case"orderTransactions":return this.orderStateMachineService.transitionOrderTransactionState((l=n.transactions.first())==null?void 0:l.id,o.value,a,{},{"sw-skip-trigger-flow":!r});case"orderDeliveries":return this.orderStateMachineService.transitionOrderDeliveryState((p=n.deliveries.first())==null?void 0:p.id,o.value,a,{},{"sw-skip-trigger-flow":!r});default:return this.orderStateMachineService.transitionOrderState(n.id,o.value,a,{},{"sw-skip-trigger-flow":!r})}}))}),Promise.all(i)}async bulkEdit(t,e){this.entityIds=t;const i=await this.buildBulkSyncPayload(e);return H.isEmpty(i)?Promise.resolve({data:[]}):b.retry(()=>this.syncService.sync(i,{},{"single-operation":1,"sw-language-id":Shopware.Context.api.languageId}))}getCriteria(){const t=new N(1,25);return t.setIds(this.entityIds),t.getAssociation("deliveries"),t.getAssociation("transactions"),t}}const U=Shopware.Utils.types;class q extends R{constructor(){super(),this.name="bulkEditCustomerHandler",this.entityName="customer",this.entityIds=[],this.customerGroupRegistrationService=Shopware.Service("customerGroupRegistrationService"),this.customerRepository=Shopware.Service("repositoryFactory").create("customer")}async bulkEdit(t,e){this.entityIds=t;const i=await this.buildBulkSyncPayload(e);return U.isEmpty(i)?Promise.resolve({success:!0}):b.retry(()=>this.syncService.sync(i,{},{"single-operation":1,"sw-language-id":Shopware.Context.api.languageId}))}async bulkEditRequestedGroup(t,e){const i=[],r=Shopware.Store.get("swBulkEdit").isFlowTriggered;return e.forEach(s=>{if(s.value)switch(s.value){case"decline":i.push(b.retry(()=>{this.customerGroupRegistrationService.decline(t,{},{"sw-skip-trigger-flow":!r},{silentError:!0})}));break;case"accept":i.push(b.retry(()=>{this.customerGroupRegistrationService.accept(t,{},{"sw-skip-trigger-flow":!r},{silentError:!0})}));break;default:throw new Error}}),Promise.all(i)}}class G{constructor(){this.handlers={product:()=>new B,order:()=>new K,customer:()=>new q}}getHandler(t){if(!this.handlers[t])throw Error(`Bulk Edit Handler not found for ${t} module`);return this.handlers[t]()}}Shopware.Service().register("bulkEditApiFactory",()=>new G);Shopware.Component.register("sw-bulk-edit-product",()=>h(()=>import("./index-C3jRtoXN.js"),__vite__mapDeps([0,1,2,3])));Shopware.Component.register("sw-bulk-edit-order",()=>h(()=>import("./index-CmvjEvre.js"),__vite__mapDeps([4,2,5])));Shopware.Component.register("sw-bulk-edit-customer",()=>h(()=>import("./index-B7VNd1OW.js"),__vite__mapDeps([6,2,7])));Shopware.Component.register("sw-bulk-edit-order-documents",()=>h(()=>import("./index-Ck6-WAto.js"),__vite__mapDeps([8,9])));Shopware.Component.register("sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-BurtPUY5.js"),__vite__mapDeps([10,11])));Shopware.Component.extend("sw-bulk-edit-order-documents-generate-cancellation-invoice","sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-GrSJWMEV.js"),[]));Shopware.Component.extend("sw-bulk-edit-order-documents-generate-delivery-note","sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-d-iZCTQ7.js"),[]));Shopware.Component.extend("sw-bulk-edit-order-documents-generate-credit-note","sw-bulk-edit-order-documents-generate-invoice",()=>h(()=>import("./index-BNP5JrU1.js"),[]));Shopware.Component.register("sw-bulk-edit-order-documents-download-documents",()=>h(()=>import("./index-D9koAEil.js"),__vite__mapDeps([12,13])));Shopware.Component.extend("sw-bulk-edit-custom-fields","sw-custom-field-set-renderer",()=>h(()=>import("./index-BRTXT8tk.js"),__vite__mapDeps([14,15])));Shopware.Component.register("sw-bulk-edit-change-type",()=>h(()=>import("./index-CV9l5lDq.js"),__vite__mapDeps([16,17])));Shopware.Component.register("sw-bulk-edit-change-type-field-renderer",()=>h(()=>import("./index-BtmA_pwY.js"),__vite__mapDeps([18,19])));Shopware.Component.extend("sw-bulk-edit-form-field-renderer","sw-form-field-renderer",()=>h(()=>import("./index-5ESPawL2.js"),[]));Shopware.Component.register("sw-bulk-edit-product-visibility",()=>h(()=>import("./index-BUjs_bSR.js"),[]));Shopware.Component.register("sw-bulk-edit-product-media",()=>h(()=>import("./index-CA1-I_h-.js"),[]));Shopware.Component.extend("sw-bulk-edit-product-media-form","sw-product-media-form",()=>h(()=>import("./index-BfKDqITl.js"),[]));Shopware.Component.extend("sw-bulk-edit-product-description","sw-text-editor",()=>h(()=>import("./index-1zuITKmm.js"),[]));Shopware.Component.register("sw-bulk-edit-save-modal",()=>h(()=>import("./index-C8oxf1Mq.js"),__vite__mapDeps([20,21])));Shopware.Component.register("sw-bulk-edit-save-modal-confirm",()=>h(()=>import("./index-Cx3rh9k9.js"),__vite__mapDeps([22,23])));Shopware.Component.register("sw-bulk-edit-save-modal-process",()=>h(()=>import("./index-0ah09VFe.js"),__vite__mapDeps([24,25])));Shopware.Component.register("sw-bulk-edit-save-modal-success",()=>h(()=>import("./index-DjO6XcPo.js"),__vite__mapDeps([26,27])));Shopware.Component.register("sw-bulk-edit-save-modal-error",()=>h(()=>import("./index-CD9OvigI.js"),[]));const{Module:W}=Shopware;W.register("sw-bulk-edit",{type:"core",name:"bulk-edit",title:"sw-bulk-edit.general.mainMenuTitle",description:"sw-bulk-edit.general.descriptionTextModule",version:"1.0.0",targetVersion:"1.0.0",routes:{product:{component:"sw-bulk-edit-product",path:"product/:parentId/:includesDigital",meta:{parentPath:"sw.product.index"},children:{save:{component:"sw-bulk-edit-save-modal",path:"save",redirect:{name:"sw.bulk.edit.product.save.confirm"},children:{confirm:{component:"sw-bulk-edit-save-modal-confirm",path:"confirm"},process:{component:"sw-bulk-edit-save-modal-process",path:"process"},success:{component:"sw-bulk-edit-save-modal-success",path:"success"},error:{component:"sw-bulk-edit-save-modal-error",path:"error"}}}}},order:{component:"sw-bulk-edit-order",path:"order/:excludeDelivery",meta:{parentPath:"sw.order.index"},children:{save:{component:"sw-bulk-edit-save-modal",path:"save",redirect:{name:"sw.bulk.edit.order.save.confirm"},children:{confirm:{component:"sw-bulk-edit-save-modal-confirm",path:"confirm"},process:{component:"sw-bulk-edit-save-modal-process",path:"process"},success:{component:"sw-bulk-edit-save-modal-success",path:"success"},error:{component:"sw-bulk-edit-save-modal-error",path:"error"}}}}},customer:{component:"sw-bulk-edit-customer",path:"customer",meta:{parentPath:"sw.customer.index"},children:{save:{component:"sw-bulk-edit-save-modal",path:"save",redirect:{name:"sw.bulk.edit.customer.save.confirm"},children:{confirm:{component:"sw-bulk-edit-save-modal-confirm",path:"confirm"},process:{component:"sw-bulk-edit-save-modal-process",path:"process"},success:{component:"sw-bulk-edit-save-modal-success",path:"success"},error:{component:"sw-bulk-edit-save-modal-error",path:"error"}}}}}}});
