const C=`{% block sw_flow_trigger %} <div class="sw-flow-trigger" :class="swFlowTriggerClasses" > {% block sw_flow_trigger_select_field %} <div class="sw-flow-trigger__select-toolbar"> <sw-contextual-field v-tooltip="{ message: getEventName(eventName), disabled: !eventName || isUnknownTrigger, }" class="sw-flow-trigger__search-field" :required="!isTemplate" :label="$tc('sw-flow.detail.trigger.name')" :disabled="disabled" :error="flowEventNameError" > <template #sw-field-input="{ identification, disabled, error, size, setFocusClass, removeFocusClass }"> {% block sw_flow_trigger_select_field_input %} <input ref="searchInput" v-model="searchTerm" type="text" class="sw-flow-trigger__input-field" :placeholder="triggerNamePlaceholder" :disabled="disabled" @focus="openDropdown({ setFocusClass, removeFocusClass });" > {% endblock %} {% block sw_flow_trigger_loader %} <sw-loader v-if="isLoading" class="sw-flow-trigger__loader" size="16px" /> {% endblock %} {% block sw_flow_trigger_dropdown_icon %} <sw-icon class="sw-flow-trigger__dropdown-icon" name="regular-chevron-down-xs" size="10px" @click="openDropdown({ setFocusClass, removeFocusClass });" /> {% endblock %} </template> </sw-contextual-field> </div> {% endblock %} {% block sw_flow_trigger_select_transition %} <transition name="sw-flow-trigger__fade-down"> {% block sw_flow_trigger_event_selection %} <div v-if="isExpanded" class="sw-flow-trigger__event-selection" > {% block sw_flow_trigger_container %} <sw-container class="sw-flow-trigger__event-container"> {% block sw_flow_trigger_select_tree %} <sw-tree v-if="showTreeView" ref="flowTriggerTree" :active-tree-item-id="eventName" route-params-active-element-id="eventName" :sortable="false" :items="eventTree" :searchable="false" :disable-context-menu="true" :on-change-route="changeTrigger" bind-items-to-folder > {% block sw_flow_trigger_tree_headline %} <template #headline> <span></span> </template> {% endblock %} {% block sw_flow_trigger_tree_search %} <template #search> <span></span> </template> {% endblock %} <template #items="{ treeItems, sortable, disableContextMenu, onChangeRoute, newElementId, checkItem }" > <sw-tree-item v-for="item in treeItems" :key="item.id" should-focus :active-focus-id="selectedTreeItem.id" :sortable="sortable" :item="item" :on-change-route="onChangeRoute" :display-checkbox="false" @check-item="checkItem" > {% block sw_flow_trigger_tree_item_actions %} <template #actions> <span></span> </template> {% endblock %} </sw-tree-item> </template> </sw-tree> {% endblock %} {% block sw_flow_trigger_search_list %} <ul v-else-if="searchResult.length > 0 && searchTerm.length > 0" class="sw-flow-trigger__search-results" > {% block sw_flow_trigger_search_list_item %} <li v-for="item in searchResult" :key="item.id" class="sw-flow-trigger__search-result" :class="{ 'is--focus': isSearchResultInFocus(item)}" role="button" tabindex="0" @click="onClickSearchItem(item)" @keydown.enter="onClickSearchItem(item)" > {% block sw_flow_trigger_search_list_item_icon %} <div class="sw-flow-trigger__search-result-icon"> <sw-icon name="regular-circle-xxs" size="18" /> </div> {% endblock %} {% block sw_flow_trigger_search_list_item_name %} <span class="sw-flow-trigger__search-result-name"> {% block sw_flow_trigger_search_list_item_name_highlight %} <sw-highlight-text :search-term="searchTerm" :text="getEventName(item.name)" /> {% endblock %} </span> {% endblock %} </li> {% endblock %} </ul> {% endblock %} {% block sw_flow_trigger_search_empty %} <p v-else class="sw-flow-trigger__empty" > {{ $tc('sw-flow.detail.trigger.textNoEvent') }} </p> {% endblock %} </sw-container> {% endblock %} </div> {% endblock %} </transition> {% endblock %} {% block sw_flow_event_change_confirm_modal %} <sw-flow-event-change-confirm-modal v-if="showConfirmModal" @modal-confirm="onConfirm" @modal-close="onCloseConfirm" /> {% endblock %} </div> {% endblock %}`,{Component:E,Store:g}=Shopware,{mapPropertyErrors:N,mapState:x}=E.getComponentHelper(),I=Shopware.Utils,{camelCase:F,capitalizeString:S}=Shopware.Utils.string,{isEmpty:y}=I.types,R={template:C,inject:["repositoryFactory","businessEventService"],emits:["option-select"],props:{overlay:{type:Boolean,required:!1,default:!0},disabled:{type:Boolean,required:!1,default:!1},eventName:{type:String,required:!0},isUnknownTrigger:{type:Boolean,required:!1,default:!1}},data(){return{isExpanded:!1,isLoading:!1,searchTerm:"",searchResult:[],searchResultFocusItem:{},selectedTreeItem:{},setInputFocusClass:null,removeInputFocusClass:null,showConfirmModal:!1,triggerSelect:{}}},computed:{swFlowTriggerClasses(){return{overlay:this.overlay}},formatEventName(){return this.eventName?this.getEventName(this.eventName):this.eventName},showTreeView(){return this.eventTree.length>=0&&(this.searchTerm.length<=0||this.searchTerm===this.formatEventName)},eventTree(){return this.getEventTree(this.triggerEvents)},isTemplate(){var e;return((e=this.$route.query)==null?void 0:e.type)==="template"},triggerNamePlaceholder(){return this.isUnknownTrigger?this.$tc("sw-flow.detail.trigger.unknownTriggerPlaceholder"):this.$tc("sw-flow.detail.trigger.placeholder")},...x(()=>g.get("swFlow"),["flow","triggerEvents","isSequenceEmpty"]),...N("flow",["eventName"])},watch:{eventName:{immediate:!0,handler(e){e&&(this.$route.params.eventName=e,this.searchTerm=this.getEventName(e))}},searchTerm(e){if(!e||e===this.formatEventName)return;const t=e.split(/[\W_]+/gi);this.searchResult=this.triggerEvents.filter(r=>{const s=this.getEventName(r.name).toLowerCase();return t.every(i=>s.includes(i.toLowerCase()))}),this.searchResult.length>0&&(this.searchResultFocusItem=this.searchResult[0])},selectedTreeItem(e){e!=null&&e.id&&I.debounce(()=>{const t=this.findTreeItemVNodeById(e.id).$el;if(!t)return;let r=0,s=!1,i=t;for(;!s&&i;)i.classList.contains("sw-tree__content")?s=!0:(r+=i.offsetTop,i=i.offsetParent);i==null||i.scrollTo({top:r-i.clientHeight/2-50,behavior:"smooth"})},50)()}},created(){this.createdComponent()},beforeUnmount(){this.beforeDestroyComponent()},methods:{createdComponent(){document.addEventListener("click",this.handleClickEvent),document.addEventListener("keydown",this.handleGeneralKeyEvents),this.isLoading=!0,g.get("swFlow").fetchTriggerActions(),g.get("swFlow").triggerEvent=this.getDataByEvent(this.eventName),g.get("swFlow").restrictedRules=this.eventName,this.isLoading=!1},beforeDestroyComponent(){document.removeEventListener("click",this.handleClickEvent),document.removeEventListener("keydown",this.handleGeneralKeyEvents)},handleClickEvent(e){const t=e.target;if(!t.closest(".sw-tree-item .is--no-children.is--disabled")){if(t.closest(".sw-tree-item .is--no-children .sw-tree-item__content")||t.closest(".sw-flow-trigger__search-result")){this.closeDropdown();return}if(t.closest(".sw-flow-trigger")===null){if(t.closest("svg"))return;this.closeDropdown(),this.searchTerm!==this.formatEventName&&(this.searchTerm=this.formatEventName)}}},handleGeneralKeyEvents(e){var r;if(e.type!=="keydown"||!this.isExpanded)return;switch(e.key.toLowerCase()){case"tab":case"escape":{this.closeDropdown();break}case"arrowdown":case"arrowleft":case"arrowright":case"arrowup":{this.handleArrowKeyEvents(e);break}case"enter":{if(this.searchTerm.length>0&&this.searchTerm!==this.formatEventName)this.onClickSearchItem(this.searchResultFocusItem),this.closeDropdown();else{if(((r=this.selectedTreeItem)==null?void 0:r.childCount)>0)return;this.changeTrigger(this.selectedTreeItem),this.closeDropdown()}break}}},handleArrowKeyEvents(e){var i,n,o,m,a,l,d;const t=e.key.toLowerCase();if(this.searchTerm.length>0&&this.searchTerm!==this.formatEventName){switch(t){case"arrowdown":{e.preventDefault(),this.changeSearchSelection("next");break}case"arrowup":{e.preventDefault(),this.changeSearchSelection("previous");break}}return}const r=this.findTreeItemVNodeById(),s=(n=(i=r==null?void 0:r.component)==null?void 0:i.proxy)==null?void 0:n.item;switch(t){case"arrowdown":{if(s!=null&&s.id){if((m=(o=r==null?void 0:r.component)==null?void 0:o.proxy)==null?void 0:m.opened){const h=this.getFirstChildById(s==null?void 0:s.id);h&&(this.selectedTreeItem=h);break}let c=this.getSibling(!0,s);if(c){this.selectedTreeItem=c;break}if(c=this.getClosestSiblingAncestor(s==null?void 0:s.parentId),c){this.selectedTreeItem=c;break}}break}case"arrowup":{if(s!=null&&s.id){const f=this.findTreeItemVNodeById(s==null?void 0:s.parentId);if(((d=(l=(a=f==null?void 0:f.component)==null?void 0:a.proxy)==null?void 0:l.item)==null?void 0:d.children[0].id)===(s==null?void 0:s.id)){const u=f.component.proxy.item;u&&(this.selectedTreeItem=u);break}const h=this.getSibling(!1,s);h&&(this.selectedTreeItem=this.getClosestSiblingDescendant(h))}break}case"arrowright":{this.toggleSelectedTreeItem(!0);break}case"arrowleft":{if(!this.toggleSelectedTreeItem(!1)){const c=this.findTreeItemVNodeById(s==null?void 0:s.parentId);if(c){const h=c.component.proxy.item;this.selectedTreeItem=h}}break}}},getClosestSiblingAncestor(e){var i,n,o;const t=this.findTreeItemVNodeById(e),r=this.getSibling(!0,t.item);if(r)return r;const s=(o=(n=(i=t==null?void 0:t.component)==null?void 0:i.proxy)==null?void 0:n.item)==null?void 0:o.parentId;return s?this.getClosestSiblingAncestor(s):null},getClosestSiblingDescendant(e){const t=this.findTreeItemVNodeById(e.id);if(t.opened&&t.item.childCount>0){const r=t.item.children.length-1,s=t.item.children[r];return s.childCount===0?s:this.getClosestSiblingDescendant(s)}return e},getFirstChildById(e,t=this.$refs.flowTriggerTree.treeItems){const r=t.find(s=>s.id===e);if(r)return r.children[0];for(let s=0;s<t.length;s+=1){const i=this.getFirstChildById(e,t[s].children);if(i)return i}return null},getSibling(e,t,r=this.$refs.flowTriggerTree.treeItems){if(!t)return null;let s=null;const i=r.indexOf(t);if(i<0?s=null:s=e?r[i+1]:r[i-1],s)return s;for(let n=0;n<r.length;n+=1){const o=this.getSibling(e,t,r[n].children);if(o)return o}return null},changeSearchSelection(e="next"){const t=e==="previous"?-1:1,r=this.searchResult.indexOf(this.searchResultFocusItem),s=this.searchResult[r+t];typeof s<"u"&&(this.searchResultFocusItem=s)},toggleSelectedTreeItem(e){var r,s,i,n;const t=this.findTreeItemVNodeById();return(s=(r=t==null?void 0:t.component)==null?void 0:r.proxy)!=null&&s.openTreeItem&&((n=(i=t==null?void 0:t.component)==null?void 0:i.proxy)==null?void 0:n.opened)!==e?(t.component.proxy.openTreeItem(),!0):!1},findTreeItemVNodeById(e=this.selectedTreeItem.id,t=(i=>(i=(s=>(s=(r=>(r=this.$refs.flowTriggerTree)==null?void 0:r.$)())==null?void 0:s.subTree)())==null?void 0:i.children)()){var m,a,l,d,f,c,h,u;let n=!1;if(!t||(Array.isArray(t)?n=t.find(w=>{var p,_,v,b,T,k;return(v=(_=(p=w.component)==null?void 0:p.proxy)==null?void 0:_.item)!=null&&v.id?((k=(T=(b=w.component)==null?void 0:b.proxy)==null?void 0:T.item)==null?void 0:k.id)===e:!1}):(l=(a=(m=t.component)==null?void 0:m.proxy)==null?void 0:a.item)!=null&&l.id&&(n=((c=(f=(d=t.component)==null?void 0:d.proxy)==null?void 0:f.item)==null?void 0:c.id)===e),n))return n;let o=!1;for(let w=0;w<t.length;w+=1){if(!t[w])continue;const p=t[w].component?(u=(h=t[w].component)==null?void 0:h.subTree)==null?void 0:u.children:t[w].children;if(o=this.findTreeItemVNodeById(e,p??null),o)break}return o},openDropdown({setFocusClass:e,removeFocusClass:t}){this.setInputFocusClass=e,this.removeInputFocusClass=t,this.setInputFocusClass(),this.isExpanded=!0,!this.isLoading&&this.$nextTick().then(()=>{if(this.searchTerm===this.formatEventName){const r=this.eventTree.find(s=>s.id===this.eventName);this.selectedTreeItem=r||this.eventTree[0]}})},closeDropdown(){this.removeInputFocusClass&&this.removeInputFocusClass(),this.isExpanded=!1},changeTrigger(e){if(!(e!=null&&e.disabled||(e==null?void 0:e.childCount)>0))if(this.isSequenceEmpty){const{id:t}=e.data;g.get("swFlow").triggerEvent=this.getDataByEvent(t),g.get("swFlow").restrictedRules=t,this.$emit("option-select",t)}else this.showConfirmModal=this.flow.eventName!==e.id,this.triggerSelect=this.getDataByEvent(e.id)},onConfirm(){g.get("swFlow").triggerEvent=this.triggerSelect,g.get("swFlow").restrictedRules=this.triggerSelect.name,this.$emit("option-select",this.triggerSelect.name)},onCloseConfirm(){this.showConfirmModal=!1,this.triggerSelect={}},getLastEventName({parentId:e=null,id:t}){const[r]=e?t.split(".").reverse():[t];return this.getEventNameTranslated(r)},getDataByEvent(e){return this.triggerEvents.find(t=>t.name===e)},hasOnlyStopFlow(e){return(this.triggerEvents.find(r=>r.name===e).aware||[]).length===0},getEventTree(e){const t={};e.forEach(s=>{const i=s.name.split(".");if(i.length===0)return;const n=(o,m,a)=>{const l=m[o],d=m[o+1];a[l]=a[l]||{id:l,parentId:null,children:{}},d&&(a[l].children[d]=a[l].children[d]||{id:`${a[l].id}.${d}`,parentId:a[l].id,children:{}},n(o+1,m,a[l].children))};n(0,i,t)});const r=(s,i=[])=>(s.forEach(n=>{const o=n.children?Object.values(n.children):[];i.push({id:n.id,name:this.getLastEventName(n),childCount:o.length,parentId:n.parentId,disabled:y(n.children)&&this.hasOnlyStopFlow(n.id),disabledToolTipText:y(n.children)&&this.hasOnlyStopFlow(n.id)?this.$tc("sw-flow.detail.trigger.textHint"):null}),o.length>0&&(i=r(o,i))}),i);return r(Object.values(t))},getBreadcrumb(e){return e?e.split(".").map(r=>S(r)).join(" / ").replace(/_|-/g," "):""},onClickSearchItem(e){this.searchTerm=this.formatEventName,this.searchResult=[],this.isSequenceEmpty?(this.$emit("option-select",e.name),g.get("swFlow").triggerEvent=e,g.get("swFlow").restrictedRules=e.name):(this.showConfirmModal=!0,this.triggerSelect=e)},getEventName(e){return this.isUnknownTrigger?"":e&&e.split(".").map(r=>this.getEventNameTranslated(r)).join(" / ")},isSearchResultInFocus(e){return e.name===this.searchResultFocusItem.name},getEventNameTranslated(e){const t=F(e),r=[`sw-flow-app.triggers-app.${t}`,`sw-flow-custom-event.event-tree.${t}`,`sw-flow.triggers.${t}`].find(s=>this.$te(s));return r?this.$tc(r):e.replace(/_|-/g," ")}}};export{R as default};
